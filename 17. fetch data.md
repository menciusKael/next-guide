##Preface

In the previous article, we discussed the basic usage of Server Actions, while in this article, we will discuss the "standard" usage of Server Actions. For example, which APIs and libraries are commonly used in conjunction with Server Actions? What should I pay attention to when writing a Server Actions?

We will also introduce some common issues encountered in developing Server Actions, such as how to make optimistic updates? How to handle errors? How to obtain data such as cookies and headers? How to redirect? wait

Let's get started.

## Form

Let's first talk about some APIs that Server Actions often use in conjunction with form submissions.

### 1. useFormStatus

first is the [useFormStatus](https://link.juejin.cn/?target=https%3A%2F%2Freact.dev%2Freference%2Freact-dom%2Fhooks%2FuseFormStatus "https://react.dev/reference/react-dom/hooks/useFormStatus")ï¼ŒThis is the official hook of React, used to return the status information of form submission. The example code is as follows:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">&#39;use client&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="2">// app/submit-button.jsx</span>
<span class="code-block-extension-codeLine" data-line-num="3">import { useFormStatus } from &#39;react-dom&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="4"></span>
<span class="code-block-extension-codeLine" data-line-num="5">export function SubmitButton() {</span>
<span class="code-block-extension-codeLine" data-line-num="6">  const { pending } = useFormStatus()</span>
<span class="code-block-extension-codeLine" data-line-num="7"></span>
<span class="code-block-extension-codeLine" data-line-num="8">  return (</span>
<span class="code-block-extension-codeLine" data-line-num="9">    <span class="xml">&lt;button type=&#34;submit&#34; aria-disabled={pending}&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="10">      {pending ? &#39;Adding&#39; : &#39;Add&#39;}</span>
<span class="code-block-extension-codeLine" data-line-num="11">    &lt;/button&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="12">  )</span>
<span class="code-block-extension-codeLine" data-line-num="13">}</span>
</code></pre>

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">// app/page.jsx</span>
<span class="code-block-extension-codeLine" data-line-num="2">import { SubmitButton } from &#39;@/app/submit-button&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="3"></span>
<span class="code-block-extension-codeLine" data-line-num="4">export default async function Home() {</span>
<span class="code-block-extension-codeLine" data-line-num="5">  return (</span>
<span class="code-block-extension-codeLine" data-line-num="6">    <span class="xml">&lt;form action={...}&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="7">      &lt;input type=&#34;text&#34; name=&#34;field-name&#34; /&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="8">      &lt;SubmitButton /&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="9">    &lt;/form&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="10">  )</span>
<span class="code-block-extension-codeLine" data-line-num="11">}</span>
</code></pre>

When using it, it is important to note that useFormStatus must be used within the component under '<form>', just like this example code. First, create a button component, call useFormStatus inside the component, and then reference the component under '<form>'. Writing like this is incorrect as it cannot be completely written into a component:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">function Form() {</span>
<span class="code-block-extension-codeLine" data-line-num="2">  // ðŸš© `pending` will never be true</span>
<span class="code-block-extension-codeLine" data-line-num="3">  // useFormStatus does not track the form rendered in this component</span>
<span class="code-block-extension-codeLine" data-line-num="4">  const { pending } = useFormStatus();</span>
<span class="code-block-extension-codeLine" data-line-num="5">  return <span class="xml">&lt;form action={submit}&gt;&lt;/form&gt;</span>;</span>
<span class="code-block-extension-codeLine" data-line-num="6">}</span>
</code></pre>

### 2. useFormState

then [useFormState](https://link.juejin.cn/?target=https%3A%2F%2Freact.dev%2Freference%2Freact-dom%2Fhooks%2FuseFormState "https://react.dev/reference/react-dom/hooks/useFormState")ï¼ŒThis is also the official hook of React, which updates the status based on the results of the form action.

The example code used in React is as follows:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">import { useFormState } from &#34;react-dom&#34;;</span>
<span class="code-block-extension-codeLine" data-line-num="2"></span>
<span class="code-block-extension-codeLine" data-line-num="3">async function increment(previousState, formData) {</span>
<span class="code-block-extension-codeLine" data-line-num="4">  return previousState + 1;</span>
<span class="code-block-extension-codeLine" data-line-num="5">}</span>
<span class="code-block-extension-codeLine" data-line-num="6"></span>
<span class="code-block-extension-codeLine" data-line-num="7">function StatefulForm({}) {</span>
<span class="code-block-extension-codeLine" data-line-num="8">  const [state, formAction] = useFormState(increment, 0);</span>
<span class="code-block-extension-codeLine" data-line-num="9">  return (</span>
<span class="code-block-extension-codeLine" data-line-num="10">    <span class="xml">&lt;form&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="11">      {state}</span>
<span class="code-block-extension-codeLine" data-line-num="12">      &lt;button formAction={formAction}&gt;Increment&lt;/button&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="13">    &lt;/form&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="14">  )</span>
<span class="code-block-extension-codeLine" data-line-num="15">}</span>
</code></pre>

When used in Next.js and combined with Server Actions, the example code is as follows:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">&#39;use client&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="2"></span>
<span class="code-block-extension-codeLine" data-line-num="3">import { useFormState } from &#39;react-dom&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="4"></span>
<span class="code-block-extension-codeLine" data-line-num="5">export default function Home() {</span>
<span class="code-block-extension-codeLine" data-line-num="6"></span>
<span class="code-block-extension-codeLine" data-line-num="7">  async function createTodo(prevState, formData) {</span>
<span class="code-block-extension-codeLine" data-line-num="8">    return prevState.concat(formData.get(&#39;todo&#39;));</span>
<span class="code-block-extension-codeLine" data-line-num="9">  }</span>
<span class="code-block-extension-codeLine" data-line-num="10"></span>
<span class="code-block-extension-codeLine" data-line-num="11">  const [state, formAction] = useFormState(createTodo, [])</span>
<span class="code-block-extension-codeLine" data-line-num="12"></span>
<span class="code-block-extension-codeLine" data-line-num="13">  return (</span>
<span class="code-block-extension-codeLine" data-line-num="14">    <span class="xml">&lt;form action={formAction}&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="15">      &lt;input type=&#34;text&#34; name=&#34;todo&#34; /&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="16">      &lt;button type=&#34;submit&#34;&gt;Submit&lt;/button&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="17">      &lt;p&gt;{state.join(&#39;,&#39;)}&lt;/p&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="18">    &lt;/form&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="19">  ) </span>
<span class="code-block-extension-codeLine" data-line-num="20">}</span>
</code></pre>

### 3. Practical experience

Now let's combine useFormStatus and useFormState to explain how to handle form submissions using Server Actions. The directories and files involved are as follows:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">app                 </span>
<span class="code-block-extension-codeLine" data-line-num="2">â””â”€ form3           </span>
<span class="code-block-extension-codeLine" data-line-num="3">   â”œâ”€ actions.js   </span>
<span class="code-block-extension-codeLine" data-line-num="4">   â”œâ”€ form.js      </span>
<span class="code-block-extension-codeLine" data-line-num="5">   â””â”€ page.js            </span>
</code></pre>

`App/form3/form. js `, code as follows:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">import { findToDos } from &#39;./actions&#39;;</span>
<span class="code-block-extension-codeLine" data-line-num="2">import AddToDoForm from &#39;./form&#39;;</span>
<span class="code-block-extension-codeLine" data-line-num="3"></span>
<span class="code-block-extension-codeLine" data-line-num="4">export default async function Page() {</span>
<span class="code-block-extension-codeLine" data-line-num="5">  const todos = await findToDos();</span>
<span class="code-block-extension-codeLine" data-line-num="6">  return (</span>
<span class="code-block-extension-codeLine" data-line-num="7">    <span class="xml">&lt;&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="8">      &lt;AddToDoForm /&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="9">      &lt;ul&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="10">        {todos.map((todo, i) =&gt; &lt;li key={i}&gt;{todo}&lt;/li&gt;)}</span>
<span class="code-block-extension-codeLine" data-line-num="11">      &lt;/ul&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="12">    &lt;/&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="13">  )</span>
<span class="code-block-extension-codeLine" data-line-num="14">}</span>
</code></pre>

`App/form3/form. js `, code as follows:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">&#39;use client&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="2"></span>
<span class="code-block-extension-codeLine" data-line-num="3">import { useFormState, useFormStatus } from &#39;react-dom&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="4">import { createToDo } from &#39;./actions&#39;;</span>
<span class="code-block-extension-codeLine" data-line-num="5"></span>
<span class="code-block-extension-codeLine" data-line-num="6">const initialState = {</span>
<span class="code-block-extension-codeLine" data-line-num="7">  message: &#39;&#39;,</span>
<span class="code-block-extension-codeLine" data-line-num="8">}</span>
<span class="code-block-extension-codeLine" data-line-num="9"></span>
<span class="code-block-extension-codeLine" data-line-num="10">function SubmitButton() {</span>
<span class="code-block-extension-codeLine" data-line-num="11">  const { pending } = useFormStatus()</span>
<span class="code-block-extension-codeLine" data-line-num="12">  return (</span>
<span class="code-block-extension-codeLine" data-line-num="13">    <span class="xml">&lt;button type=&#34;submit&#34; aria-disabled={pending}&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="14">      {pending ? &#39;Adding&#39; : &#39;Add&#39;}</span>
<span class="code-block-extension-codeLine" data-line-num="15">    &lt;/button&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="16">  )</span>
<span class="code-block-extension-codeLine" data-line-num="17">}</span>
<span class="code-block-extension-codeLine" data-line-num="18"></span>
<span class="code-block-extension-codeLine" data-line-num="19">export default function AddToDoForm() {</span>
<span class="code-block-extension-codeLine" data-line-num="20">  const [state, formAction] = useFormState(createToDo, initialState)</span>
<span class="code-block-extension-codeLine" data-line-num="21"></span>
<span class="code-block-extension-codeLine" data-line-num="22">  return (</span>
<span class="code-block-extension-codeLine" data-line-num="23">    <span class="xml">&lt;form action={formAction}&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="24">      &lt;input type=&#34;text&#34; name=&#34;todo&#34; /&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="25">      &lt;SubmitButton /&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="26">      &lt;p aria-live=&#34;polite&#34; className=&#34;sr-only&#34;&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="27">        {state?.message}</span>
<span class="code-block-extension-codeLine" data-line-num="28">      &lt;/p&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="29">    &lt;/form&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="30">  )</span>
<span class="code-block-extension-codeLine" data-line-num="31">}</span>
</code></pre>

`App/form3/actions. js `, the code is as follows:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">&#39;use server&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="2"></span>
<span class="code-block-extension-codeLine" data-line-num="3">import { revalidatePath } from &#34;next/cache&#34;;</span>
<span class="code-block-extension-codeLine" data-line-num="4"></span>
<span class="code-block-extension-codeLine" data-line-num="5">const sleep = ms =&gt; new Promise(r =&gt; setTimeout(r, ms));</span>
<span class="code-block-extension-codeLine" data-line-num="6"></span>
<span class="code-block-extension-codeLine" data-line-num="7">let data = [&#39;read&#39;, &#39;write&#39;, &#39;think&#39;]</span>
<span class="code-block-extension-codeLine" data-line-num="8"></span>
<span class="code-block-extension-codeLine" data-line-num="9">export async function findToDos() {</span>
<span class="code-block-extension-codeLine" data-line-num="10">  return data</span>
<span class="code-block-extension-codeLine" data-line-num="11">}</span>
<span class="code-block-extension-codeLine" data-line-num="12"></span>
<span class="code-block-extension-codeLine" data-line-num="13">export async function createToDo(prevState, formData) {</span>
<span class="code-block-extension-codeLine" data-line-num="14">  await sleep(500)</span>
<span class="code-block-extension-codeLine" data-line-num="15">  const todo = formData.get(&#39;todo&#39;)</span>
<span class="code-block-extension-codeLine" data-line-num="16">  data.push(todo)</span>
<span class="code-block-extension-codeLine" data-line-num="17">  revalidatePath(&#34;/form3&#34;);</span>
<span class="code-block-extension-codeLine" data-line-num="18">  return {</span>
<span class="code-block-extension-codeLine" data-line-num="19">    message: `add ${todo} success!`</span>
<span class="code-block-extension-codeLine" data-line-num="20">  }</span>
<span class="code-block-extension-codeLine" data-line-num="21">}</span>
</code></pre>

The interaction effect is as follows:

![actions-6.gif](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d9b1592d85124e03a2cd6d927ea6686b~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=847&h=558&s=81417&e=gif&f=37&b=fefefe) Note: When using useFormState, the first parameter corresponding to the Server Action function is prevState, and the second parameter is formData. When using useFormStatus, it should be written in a separate component under the form. When using, pay attention to these two points.

It is worth mentioning that:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">&lt;p aria-live=&#34;polite&#34; className=&#34;sr-only&#34;&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="2">  {state?.message}</span>
<span class="code-block-extension-codeLine" data-line-num="3">&lt;/p&gt;</span>
</code></pre>

`Aria live 'indicates that this is an ARIA tag used to politely notify users of a change` "SR only" indicates that this is content only used for screen readers. Because we did not set the style of SR only, it was exposed on the page, and theoretically, the following style should be added:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-css code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">.sr-only {</span>
<span class="code-block-extension-codeLine" data-line-num="2">  position: absolute;</span>
<span class="code-block-extension-codeLine" data-line-num="3">  width: 1px;</span>
<span class="code-block-extension-codeLine" data-line-num="4">  height: 1px;</span>
<span class="code-block-extension-codeLine" data-line-num="5">  padding: 0;</span>
<span class="code-block-extension-codeLine" data-line-num="6">  margin: -1px;</span>
<span class="code-block-extension-codeLine" data-line-num="7">  overflow: hidden;</span>
<span class="code-block-extension-codeLine" data-line-num="8">  clip: rect(0, 0, 0, 0);</span>
<span class="code-block-extension-codeLine" data-line-num="9">  white-space: nowrap;</span>
<span class="code-block-extension-codeLine" data-line-num="10">  border-width: 0;</span>
<span class="code-block-extension-codeLine" data-line-num="11">}</span>
</code></pre>

Simply put, this content should not be displayed on the screen. The return of this information is used to notify people who cannot see the screen content like normal people and need to use screen reader tools to successfully create the task.

## Server Actions

Next, let's talk about the key points to note when writing Server Actions. Simply put, it is important to note:

1. Obtain submitted data
2. Perform data validation and error handling
3. Re validate data
4. Error handling

### 1. get data

If using the most basic form of form action, the first parameter of the Server Action function is formData:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">export default function Page() {</span>
<span class="code-block-extension-codeLine" data-line-num="2">  async function createInvoice(formData) {</span>
<span class="code-block-extension-codeLine" data-line-num="3">    &#39;use server&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="4"></span>
<span class="code-block-extension-codeLine" data-line-num="5">    const rawFormData = {</span>
<span class="code-block-extension-codeLine" data-line-num="6">      customerId: formData.get(&#39;customerId&#39;)</span>
<span class="code-block-extension-codeLine" data-line-num="7">    }</span>
<span class="code-block-extension-codeLine" data-line-num="8"></span>
<span class="code-block-extension-codeLine" data-line-num="9">    // mutate data</span>
<span class="code-block-extension-codeLine" data-line-num="10">    // revalidate cache</span>
<span class="code-block-extension-codeLine" data-line-num="11">  }</span>
<span class="code-block-extension-codeLine" data-line-num="12"></span>
<span class="code-block-extension-codeLine" data-line-num="13">  return <span class="xml">&lt;form action={createInvoice}&gt;...&lt;/form&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="14">}</span>
</code></pre>

If using the form of form action+useFormState, the first parameter of the Server Actions function is prevState, and the second parameter is formData:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">&#39;use client&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="2"></span>
<span class="code-block-extension-codeLine" data-line-num="3">import { useFormState } from &#39;react-dom&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="4"></span>
<span class="code-block-extension-codeLine" data-line-num="5">export default function Home() {</span>
<span class="code-block-extension-codeLine" data-line-num="6"></span>
<span class="code-block-extension-codeLine" data-line-num="7">  async function createTodo(prevState, formData) {</span>
<span class="code-block-extension-codeLine" data-line-num="8">    return prevState.concat(formData.get(&#39;todo&#39;));</span>
<span class="code-block-extension-codeLine" data-line-num="9">  }</span>
<span class="code-block-extension-codeLine" data-line-num="10"></span>
<span class="code-block-extension-codeLine" data-line-num="11">  const [state, formAction] = useFormState(createTodo, [])</span>
<span class="code-block-extension-codeLine" data-line-num="12"></span>
<span class="code-block-extension-codeLine" data-line-num="13">  return (</span>
<span class="code-block-extension-codeLine" data-line-num="14">    <span class="xml">&lt;form action={formAction}&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="15">      &lt;input type=&#34;text&#34; name=&#34;todo&#34; /&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="16">      &lt;button type=&#34;submit&#34;&gt;Submit&lt;/button&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="17">      &lt;p&gt;{state.join(&#39;,&#39;)}&lt;/p&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="18">    &lt;/form&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="19">  ) </span>
<span class="code-block-extension-codeLine" data-line-num="20">}</span>
</code></pre>

If it is a direct call, then it depends on how it is passed in during the call, such as the example of event call mentioned in the previous article:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">&#39;use client&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="2"></span>
<span class="code-block-extension-codeLine" data-line-num="3">import { createToDoDirectly } from &#39;./actions&#39;;</span>
<span class="code-block-extension-codeLine" data-line-num="4"></span>
<span class="code-block-extension-codeLine" data-line-num="5">export default function Button({children}) {</span>
<span class="code-block-extension-codeLine" data-line-num="6">  return <span class="xml">&lt;button onClick={async () =&gt; {</span></span>
<span class="code-block-extension-codeLine" data-line-num="7">    const data = await createToDoDirectly(&#39;sport&#39;)</span>
<span class="code-block-extension-codeLine" data-line-num="8">    alert(JSON.stringify(data))</span>
<span class="code-block-extension-codeLine" data-line-num="9">  }}&gt;{children}&lt;/button&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="10">}</span>
</code></pre>

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">&#39;use server&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="2"></span>
<span class="code-block-extension-codeLine" data-line-num="3">export async function createToDoDirectly(value) {</span>
<span class="code-block-extension-codeLine" data-line-num="4">  const form = new FormData()</span>
<span class="code-block-extension-codeLine" data-line-num="5">  form.append(&#34;todo&#34;, value);</span>
<span class="code-block-extension-codeLine" data-line-num="6">  return createToDo(form)</span>
<span class="code-block-extension-codeLine" data-line-num="7">}</span>
</code></pre>

### 2. Form Validation

Next.js recommends using HTML element built-in validations such as' required 'and' type="email" for basic form validation.

For higher-order server-side data validation, you can use [zod](https://link.juejin.cn/?target=https%3A%2F%2Fzod.dev%2F "https://zod.dev/") This schema validation library is used to validate the structure of form data:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">&#39;use server&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="2"></span>
<span class="code-block-extension-codeLine" data-line-num="3">import { z } from &#39;zod&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="4"></span>
<span class="code-block-extension-codeLine" data-line-num="5">const schema = z.object({</span>
<span class="code-block-extension-codeLine" data-line-num="6">  email: z.string({</span>
<span class="code-block-extension-codeLine" data-line-num="7">    invalid_type_error: &#39;Invalid Email&#39;,</span>
<span class="code-block-extension-codeLine" data-line-num="8">  }),</span>
<span class="code-block-extension-codeLine" data-line-num="9">})</span>
<span class="code-block-extension-codeLine" data-line-num="10"></span>
<span class="code-block-extension-codeLine" data-line-num="11">export default async function createsUser(formData) {</span>
<span class="code-block-extension-codeLine" data-line-num="12">  const validatedFields = schema.safeParse({</span>
<span class="code-block-extension-codeLine" data-line-num="13">    email: formData.get(&#39;email&#39;),</span>
<span class="code-block-extension-codeLine" data-line-num="14">  })</span>
<span class="code-block-extension-codeLine" data-line-num="15"></span>
<span class="code-block-extension-codeLine" data-line-num="16">  // Return early if the form data is invalid</span>
<span class="code-block-extension-codeLine" data-line-num="17">  if (!validatedFields.success) {</span>
<span class="code-block-extension-codeLine" data-line-num="18">    return {</span>
<span class="code-block-extension-codeLine" data-line-num="19">      errors: validatedFields.error.flatten().fieldErrors,</span>
<span class="code-block-extension-codeLine" data-line-num="20">    }</span>
<span class="code-block-extension-codeLine" data-line-num="21">  }</span>
<span class="code-block-extension-codeLine" data-line-num="22"></span>
<span class="code-block-extension-codeLine" data-line-num="23">  // Mutate data</span>
<span class="code-block-extension-codeLine" data-line-num="24">}</span>
</code></pre>

### 3. Re validate data

After modifying data in Server Action, it is important to re validate the data, otherwise the data will not be updated in a timely manner.

Use revolidatePath:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">&#39;use server&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="2"></span>
<span class="code-block-extension-codeLine" data-line-num="3">import { revalidatePath } from &#39;next/cache&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="4"></span>
<span class="code-block-extension-codeLine" data-line-num="5">export async function createPost() {</span>
<span class="code-block-extension-codeLine" data-line-num="6">  try {</span>
<span class="code-block-extension-codeLine" data-line-num="7">    // ...</span>
<span class="code-block-extension-codeLine" data-line-num="8">  } catch (error) {</span>
<span class="code-block-extension-codeLine" data-line-num="9">    // ...</span>
<span class="code-block-extension-codeLine" data-line-num="10">  }</span>
<span class="code-block-extension-codeLine" data-line-num="11"></span>
<span class="code-block-extension-codeLine" data-line-num="12">  revalidatePath(&#39;/posts&#39;)</span>
<span class="code-block-extension-codeLine" data-line-num="13">}</span>
</code></pre>

use revalidateTagï¼š

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">&#39;use server&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="2"></span>
<span class="code-block-extension-codeLine" data-line-num="3">import { revalidateTag } from &#39;next/cache&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="4"></span>
<span class="code-block-extension-codeLine" data-line-num="5">export async function createPost() {</span>
<span class="code-block-extension-codeLine" data-line-num="6">  try {</span>
<span class="code-block-extension-codeLine" data-line-num="7">    // ...</span>
<span class="code-block-extension-codeLine" data-line-num="8">  } catch (error) {</span>
<span class="code-block-extension-codeLine" data-line-num="9">    // ...</span>
<span class="code-block-extension-codeLine" data-line-num="10">  }</span>
<span class="code-block-extension-codeLine" data-line-num="11"></span>
<span class="code-block-extension-codeLine" data-line-num="12">  revalidateTag(&#39;posts&#39;)</span>
<span class="code-block-extension-codeLine" data-line-num="13">}</span>
</code></pre>

### 4. error handling

One way is to return error information. For example, when an entry creation fails and returns an error message:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">&#39;use server&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="2">// app/actions.js</span>
<span class="code-block-extension-codeLine" data-line-num="3">export async function createTodo(prevState, formData) {</span>
<span class="code-block-extension-codeLine" data-line-num="4">  try {</span>
<span class="code-block-extension-codeLine" data-line-num="5">    await createItem(formData.get(&#39;todo&#39;))</span>
<span class="code-block-extension-codeLine" data-line-num="6">    return revalidatePath(&#39;/&#39;)</span>
<span class="code-block-extension-codeLine" data-line-num="7">  } catch (e) {</span>
<span class="code-block-extension-codeLine" data-line-num="8">    return { message: &#39;Failed to create&#39; }</span>
<span class="code-block-extension-codeLine" data-line-num="9">  }</span>
<span class="code-block-extension-codeLine" data-line-num="10">}</span>
</code></pre>

In the client component, read this value and display an error message:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">&#39;use client&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="2">// app/add-form.jsx</span>
<span class="code-block-extension-codeLine" data-line-num="3">import { useFormState, useFormStatus } from &#39;react-dom&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="4">import { createTodo } from &#39;@/app/actions&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="5"></span>
<span class="code-block-extension-codeLine" data-line-num="6">const initialState = {</span>
<span class="code-block-extension-codeLine" data-line-num="7">  message: null,</span>
<span class="code-block-extension-codeLine" data-line-num="8">}</span>
<span class="code-block-extension-codeLine" data-line-num="9"></span>
<span class="code-block-extension-codeLine" data-line-num="10">function SubmitButton() {</span>
<span class="code-block-extension-codeLine" data-line-num="11">  const { pending } = useFormStatus()</span>
<span class="code-block-extension-codeLine" data-line-num="12"></span>
<span class="code-block-extension-codeLine" data-line-num="13">  return (</span>
<span class="code-block-extension-codeLine" data-line-num="14">    <span class="xml">&lt;button type=&#34;submit&#34; aria-disabled={pending}&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="15">      Add</span>
<span class="code-block-extension-codeLine" data-line-num="16">    &lt;/button&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="17">  )</span>
<span class="code-block-extension-codeLine" data-line-num="18">}</span>
<span class="code-block-extension-codeLine" data-line-num="19"></span>
<span class="code-block-extension-codeLine" data-line-num="20">export function AddForm() {</span>
<span class="code-block-extension-codeLine" data-line-num="21">  const [state, formAction] = useFormState(createTodo, initialState)</span>
<span class="code-block-extension-codeLine" data-line-num="22"></span>
<span class="code-block-extension-codeLine" data-line-num="23">  return (</span>
<span class="code-block-extension-codeLine" data-line-num="24">    <span class="xml">&lt;form action={formAction}&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="25">      &lt;label htmlFor=&#34;todo&#34;&gt;Enter Task&lt;/label&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="26">      &lt;input type=&#34;text&#34; id=&#34;todo&#34; name=&#34;todo&#34; required /&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="27">      &lt;SubmitButton /&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="28">      &lt;p aria-live=&#34;polite&#34; className=&#34;sr-only&#34;&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="29">        {state?.message}</span>
<span class="code-block-extension-codeLine" data-line-num="30">      &lt;/p&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="31">    &lt;/form&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="32">  )</span>
<span class="code-block-extension-codeLine" data-line-num="33">}</span>
</code></pre>

One way is to throw an error, which will be captured by the most recent error. js:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">&#39;use client&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="2">// error.js</span>
<span class="code-block-extension-codeLine" data-line-num="3">export default function Error() {</span>
<span class="code-block-extension-codeLine" data-line-num="4">  return (</span>
<span class="code-block-extension-codeLine" data-line-num="5">    <span class="xml">&lt;h2&gt;error&lt;/h2&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="6">  )</span>
<span class="code-block-extension-codeLine" data-line-num="7">}</span>
</code></pre>

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">// page.js</span>
<span class="code-block-extension-codeLine" data-line-num="2">import { useFormState } from &#39;react-dom&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="3"></span>
<span class="code-block-extension-codeLine" data-line-num="4">function AddForm() {</span>
<span class="code-block-extension-codeLine" data-line-num="5">  async function serverActionWithError() {</span>
<span class="code-block-extension-codeLine" data-line-num="6">    &#39;use server&#39;;   </span>
<span class="code-block-extension-codeLine" data-line-num="7">    throw new Error(`This is error is in the Server Action`);</span>
<span class="code-block-extension-codeLine" data-line-num="8">  }</span>
<span class="code-block-extension-codeLine" data-line-num="9"></span>
<span class="code-block-extension-codeLine" data-line-num="10">  return (</span>
<span class="code-block-extension-codeLine" data-line-num="11">    <span class="xml">&lt;form action={serverActionWithError}&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="12">      &lt;button type=&#34;submit&#34;&gt;Submit&lt;/button&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="13">    &lt;/form&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="14">  ) </span>
<span class="code-block-extension-codeLine" data-line-num="15">}</span>
<span class="code-block-extension-codeLine" data-line-num="16"></span>
<span class="code-block-extension-codeLine" data-line-num="17">export default AddForm</span>
</code></pre>

In this way, when the Server Action encounters an error, the error UI will be displayed.

##Optimistic updates

### 1. useOptimistic

The so-called optimistic update, for example, when a user clicks a like button, the traditional approach is to wait for the interface to return successful before updating the UI. Optimistic updates involve updating the UI first and sending data requests at the same time. As for error handling after data requests, it is customized and implemented according to one's own needs.

React provides [useOptimistic](https://link.juejin.cn/?target=https%3A%2F%2Freact.dev%2Freference%2Freact%2FuseOptimistic "https://react.dev/reference/react/useOptimistic") hookï¼ŒThis is also an official hook, and its basic usage is as follows:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">import { useOptimistic } from &#39;react&#39;;</span>
<span class="code-block-extension-codeLine" data-line-num="2"></span>
<span class="code-block-extension-codeLine" data-line-num="3">function AppContainer() {</span>
<span class="code-block-extension-codeLine" data-line-num="4">  const [optimisticState, addOptimistic] = useOptimistic(</span>
<span class="code-block-extension-codeLine" data-line-num="5">    state,</span>
<span class="code-block-extension-codeLine" data-line-num="6">    // updateFn</span>
<span class="code-block-extension-codeLine" data-line-num="7">    (currentState, optimisticValue) =&gt; {</span>
<span class="code-block-extension-codeLine" data-line-num="8">      // merge and return new state</span>
<span class="code-block-extension-codeLine" data-line-num="9">      // with optimistic value</span>
<span class="code-block-extension-codeLine" data-line-num="10">    }</span>
<span class="code-block-extension-codeLine" data-line-num="11">  );</span>
<span class="code-block-extension-codeLine" data-line-num="12">}</span>
</code></pre>

The example code used in conjunction with Server Actions is as follows:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">&#39;use client&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="2"></span>
<span class="code-block-extension-codeLine" data-line-num="3">import { useOptimistic } from &#39;react&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="4">import { send } from &#39;./actions&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="5"></span>
<span class="code-block-extension-codeLine" data-line-num="6">export function Thread({ messages }) {</span>
<span class="code-block-extension-codeLine" data-line-num="7">  const [optimisticMessages, addOptimisticMessage] = useOptimistic(</span>
<span class="code-block-extension-codeLine" data-line-num="8">    messages,</span>
<span class="code-block-extension-codeLine" data-line-num="9">    (state, newMessage) =&gt; [...state, { message: newMessage }]</span>
<span class="code-block-extension-codeLine" data-line-num="10">  )</span>
<span class="code-block-extension-codeLine" data-line-num="11"></span>
<span class="code-block-extension-codeLine" data-line-num="12">  return (</span>
<span class="code-block-extension-codeLine" data-line-num="13">    <span class="xml">&lt;div&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="14">      {optimisticMessages.map((m) =&gt; (</span>
<span class="code-block-extension-codeLine" data-line-num="15">        &lt;div&gt;{m.message}&lt;/div&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="16">      ))}</span>
<span class="code-block-extension-codeLine" data-line-num="17">      &lt;form</span>
<span class="code-block-extension-codeLine" data-line-num="18">        action={async (formData) =&gt; {</span>
<span class="code-block-extension-codeLine" data-line-num="19">          const message = formData.get(&#39;message&#39;)</span>
<span class="code-block-extension-codeLine" data-line-num="20">          addOptimisticMessage(message)</span>
<span class="code-block-extension-codeLine" data-line-num="21">          await send(message)</span>
<span class="code-block-extension-codeLine" data-line-num="22">        }}</span>
<span class="code-block-extension-codeLine" data-line-num="23">      &gt;</span>
<span class="code-block-extension-codeLine" data-line-num="24">        &lt;input type=&#34;text&#34; name=&#34;message&#34; /&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="25">        &lt;button type=&#34;submit&#34;&gt;Send&lt;/button&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="26">      &lt;/form&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="27">    &lt;/div&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="28">  )</span>
<span class="code-block-extension-codeLine" data-line-num="29">}</span>
</code></pre>

### 2. Practical experience

To deepen our understanding of optimistic updates, let's write an example. The project directory and files are as follows:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">app                 </span>
<span class="code-block-extension-codeLine" data-line-num="2">â””â”€ form4           </span>
<span class="code-block-extension-codeLine" data-line-num="3">   â”œâ”€ actions.js   </span>
<span class="code-block-extension-codeLine" data-line-num="4">   â”œâ”€ form.js      </span>
<span class="code-block-extension-codeLine" data-line-num="5">   â””â”€ page.js            </span>
</code></pre>

The code for 'app/form4/page. js' is as follows:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">import { findToDos } from &#39;./actions&#39;;</span>
<span class="code-block-extension-codeLine" data-line-num="2">import Form from &#39;./form&#39;;</span>
<span class="code-block-extension-codeLine" data-line-num="3"></span>
<span class="code-block-extension-codeLine" data-line-num="4">export default async function Page() {</span>
<span class="code-block-extension-codeLine" data-line-num="5">  const todos = await findToDos();</span>
<span class="code-block-extension-codeLine" data-line-num="6">  return (</span>
<span class="code-block-extension-codeLine" data-line-num="7">    <span class="xml">&lt;Form todos={todos} /&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="8">  )</span>
<span class="code-block-extension-codeLine" data-line-num="9">}</span>
</code></pre>

`app/form4/form.js`ï¼ŒThe code is as follows:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">&#39;use client&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="2"></span>
<span class="code-block-extension-codeLine" data-line-num="3">import { useOptimistic } from &#39;react&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="4">import { useFormState } from &#39;react-dom&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="5">import { createToDo } from &#39;./actions&#39;;</span>
<span class="code-block-extension-codeLine" data-line-num="6"></span>
<span class="code-block-extension-codeLine" data-line-num="7">export default function Form({ todos }) {</span>
<span class="code-block-extension-codeLine" data-line-num="8">  const [state, sendFormAction] = useFormState(createToDo, { message: &#39;&#39; })</span>
<span class="code-block-extension-codeLine" data-line-num="9"></span>
<span class="code-block-extension-codeLine" data-line-num="10">  const [optimistiToDos, addOptimisticTodo] = useOptimistic(</span>
<span class="code-block-extension-codeLine" data-line-num="11">    todos.map((i) =&gt; ({text: i})),</span>
<span class="code-block-extension-codeLine" data-line-num="12">    (state, newTodo) =&gt; [</span>
<span class="code-block-extension-codeLine" data-line-num="13">      ...state,</span>
<span class="code-block-extension-codeLine" data-line-num="14">      {</span>
<span class="code-block-extension-codeLine" data-line-num="15">        text: newTodo,</span>
<span class="code-block-extension-codeLine" data-line-num="16">        sending: true</span>
<span class="code-block-extension-codeLine" data-line-num="17">      }</span>
<span class="code-block-extension-codeLine" data-line-num="18">    ]</span>
<span class="code-block-extension-codeLine" data-line-num="19">  );</span>
<span class="code-block-extension-codeLine" data-line-num="20"></span>
<span class="code-block-extension-codeLine" data-line-num="21">  async function formAction(formData) {</span>
<span class="code-block-extension-codeLine" data-line-num="22">    addOptimisticTodo(formData.get(&#34;todo&#34;));</span>
<span class="code-block-extension-codeLine" data-line-num="23">    await sendFormAction(formData);</span>
<span class="code-block-extension-codeLine" data-line-num="24">  }</span>
<span class="code-block-extension-codeLine" data-line-num="25"></span>
<span class="code-block-extension-codeLine" data-line-num="26">  console.log(optimistiToDos)</span>
<span class="code-block-extension-codeLine" data-line-num="27"></span>
<span class="code-block-extension-codeLine" data-line-num="28">  return (</span>
<span class="code-block-extension-codeLine" data-line-num="29">    <span class="xml">&lt;&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="30">      &lt;form action={formAction}&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="31">        &lt;input type=&#34;text&#34; name=&#34;todo&#34; /&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="32">        &lt;button type=&#34;submit&#34;&gt; Add &lt;/button&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="33">        &lt;p aria-live=&#34;polite&#34; className=&#34;sr-only&#34;&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="34">          {state?.message}</span>
<span class="code-block-extension-codeLine" data-line-num="35">        &lt;/p&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="36">      &lt;/form&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="37">      &lt;ul&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="38">        {optimistiToDos.map(({text, sending}, i) =&gt; &lt;li key={i}&gt;{text}{!!sending &amp;&amp; &lt;small&gt; (Sending...)&lt;/small&gt;}&lt;/li&gt;)}</span>
<span class="code-block-extension-codeLine" data-line-num="39">      &lt;/ul&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="40">    &lt;/&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="41">  )</span>
<span class="code-block-extension-codeLine" data-line-num="42">}</span>
</code></pre>

`app/form4/actions.js`ï¼ŒThe code is as follows:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">&#39;use server&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="2"></span>
<span class="code-block-extension-codeLine" data-line-num="3">import { revalidatePath } from &#34;next/cache&#34;;</span>
<span class="code-block-extension-codeLine" data-line-num="4"></span>
<span class="code-block-extension-codeLine" data-line-num="5">const sleep = ms =&gt; new Promise(r =&gt; setTimeout(r, ms));</span>
<span class="code-block-extension-codeLine" data-line-num="6"></span>
<span class="code-block-extension-codeLine" data-line-num="7">let data = [&#39read&#39;, &#39;write&#39;, &#39;thining&#39;]</span>
<span class="code-block-extension-codeLine" data-line-num="8"></span>
<span class="code-block-extension-codeLine" data-line-num="9">export async function findToDos() {</span>
<span class="code-block-extension-codeLine" data-line-num="10">  return data</span>
<span class="code-block-extension-codeLine" data-line-num="11">}</span>
<span class="code-block-extension-codeLine" data-line-num="12"></span>
<span class="code-block-extension-codeLine" data-line-num="13">export async function createToDo(prevState, formData) {</span>
<span class="code-block-extension-codeLine" data-line-num="14">  await sleep(2500)</span>
<span class="code-block-extension-codeLine" data-line-num="15">  const todo = formData.get(&#39;todo&#39;)</span>
<span class="code-block-extension-codeLine" data-line-num="16">  data.push(todo)</span>
<span class="code-block-extension-codeLine" data-line-num="17">  revalidatePath(&#34;/form4&#34;);</span>
<span class="code-block-extension-codeLine" data-line-num="18">  return {</span>
<span class="code-block-extension-codeLine" data-line-num="19">    message: `add ${todo} success!`</span>
<span class="code-block-extension-codeLine" data-line-num="20">  }</span>
<span class="code-block-extension-codeLine" data-line-num="21">}</span>
</code></pre>

The interaction effect is as follows:

![actions-7.gif](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a786cb80a2ea4a4eb0e4a9060ccf7d4d~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1124&h=529&s=247810&e=gif&f=65&b=fefefe)

Note: Optimistic updates are a future oriented UI update method. How to recall data when there is an interface error? What should I do if the interface is too slow and the user needs to leave during optimistic updates?

##Frequently asked questions

### 1. How to handle cookies?

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">&#39;use server&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="2"></span>
<span class="code-block-extension-codeLine" data-line-num="3">import { cookies } from &#39;next/headers&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="4"></span>
<span class="code-block-extension-codeLine" data-line-num="5">export async function exampleAction() {</span>
<span class="code-block-extension-codeLine" data-line-num="6">  // Get cookie</span>
<span class="code-block-extension-codeLine" data-line-num="7">  const value = cookies().get(&#39;name&#39;)?.value</span>
<span class="code-block-extension-codeLine" data-line-num="8"></span>
<span class="code-block-extension-codeLine" data-line-num="9">  // Set cookie</span>
<span class="code-block-extension-codeLine" data-line-num="10">  cookies().set(&#39;name&#39;, &#39;Delba&#39;)</span>
<span class="code-block-extension-codeLine" data-line-num="11"></span>
<span class="code-block-extension-codeLine" data-line-num="12">  // Delete cookie</span>
<span class="code-block-extension-codeLine" data-line-num="13">  cookies().delete(&#39;name&#39;)</span>
<span class="code-block-extension-codeLine" data-line-num="14">}</span>
</code></pre>

### 2. How to redirect?

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">&#39;use server&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="2"></span>
<span class="code-block-extension-codeLine" data-line-num="3">import { redirect } from &#39;next/navigation&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="4">import { revalidateTag } from &#39;next/cache&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="5"></span>
<span class="code-block-extension-codeLine" data-line-num="6">export async function createPost(id) {</span>
<span class="code-block-extension-codeLine" data-line-num="7">  try {</span>
<span class="code-block-extension-codeLine" data-line-num="8">    // ...</span>
<span class="code-block-extension-codeLine" data-line-num="9">  } catch (error) {</span>
<span class="code-block-extension-codeLine" data-line-num="10">    // ...</span>
<span class="code-block-extension-codeLine" data-line-num="11">  }</span>
<span class="code-block-extension-codeLine" data-line-num="12"></span>
<span class="code-block-extension-codeLine" data-line-num="13">  revalidateTag(&#39;posts&#39;) // Update cached posts</span>
<span class="code-block-extension-codeLine" data-line-num="14">  redirect(`/post/${id}`) // Navigate to the new post page</span>
<span class="code-block-extension-codeLine" data-line-num="15">}</span></code></pre>
