Suspense is a commonly used component in Next.js projects. Understanding its principles and background will help us use the Suspense component correctly.

## TraditionSSR

In two recent articles, we have introduced the principles and pitfalls of SSR. Simply put, using SSR requires a series of steps before users can view and interact with the page. The specific steps are:

1. The server obtains all data
2. Server-side rendering of HTML
3. Send the HTML, CSS, and JavaScript of the page to the client
4. Use HTML and CSS to generate non-interactive UI
5. React hydrates the user interface and makes it interactive (interactive UI)

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/14ca67632f94426e92512ed318259736~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1600&h=612&s=307750&e=png&b=161616)

These steps are sequential and blocking. This means that the server can only render HTML after fetching all data, and React can only hydrate after downloading all component code:

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fec73cefc3924b47bf4a112919bb72d6~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1600&h=748&s=373884&e=png&b=141414)

Do you still remember the shortcomings of SSR summarized in the previous article?

1. SSR data acquisition must be done before component rendering
2. The JavaScript of the component must be loaded into the client before hydration can begin.
3. All components must be hydrated before they can interact with any of them.

## Suspense

To solve these problems, React 18 introduced [&lt;Suspense&gt;](https://link.juejin.cn/?target=https%3A%2F%2Freact.dev%2Freference%2Freact%2FSuspense "https://react.dev/reference/react/Suspense") components. Let’s introduce this component:

`<Suspense>` allows you to defer rendering something until certain conditions are met (such as data being loaded).

You can wrap a dynamic component in Suspense and pass it a fallback UI to display when the dynamic component loads. If the data request is slow, using Suspense to stream the component will not affect the rendering of other parts of the page, nor will it block the entire page.

Let us write an example and create a new `app/dashboard/page.js` with the following code:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-jsx code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">import { Suspense } from &#39;react&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="2"></span>
<span class="code-block-extension-codeLine" data-line-num="3">const sleep = ms =&gt; new Promise(r =&gt; setTimeout(r, ms));</span>
<span class="code-block-extension-codeLine" data-line-num="4"></span>
<span class="code-block-extension-codeLine" data-line-num="5">async function PostFeed() {</span>
<span class="code-block-extension-codeLine" data-line-num="6">  await sleep(2000)</span>
<span class="code-block-extension-codeLine" data-line-num="7">  return <span class="xml">&lt;h1&gt;Hello PostFeed&lt;/h1&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="8">}</span>
<span class="code-block-extension-codeLine" data-line-num="9"></span>
<span class="code-block-extension-codeLine" data-line-num="10">async function Weather() {</span>
<span class="code-block-extension-codeLine" data-line-num="11">  await sleep(8000)</span>
<span class="code-block-extension-codeLine" data-line-num="12">  return <span class="xml">&lt;h1&gt;Hello Weather&lt;/h1&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="13">}</span>
<span class="code-block-extension-codeLine" data-line-num="14"></span>
<span class="code-block-extension-codeLine" data-line-num="15">async function Recommend() {</span>
<span class="code-block-extension-codeLine" data-line-num="16">  await sleep(5000)</span>
<span class="code-block-extension-codeLine" data-line-num="17">  return <span class="xml">&lt;h1&gt;Hello Recommend&lt;/h1&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="18">}</span>
<span class="code-block-extension-codeLine" data-line-num="19"></span>
<span class="code-block-extension-codeLine" data-line-num="20">export default function Dashboard() {</span>
<span class="code-block-extension-codeLine" data-line-num="21">  return (</span>
<span class="code-block-extension-codeLine" data-line-num="22">    <span class="xml">&lt;section style={{padding: &#39;20px&#39;}}&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="23">      &lt;Suspense fallback={&lt;p&gt;Loading PostFeed Component&lt;/p&gt;}&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="24">        &lt;PostFeed /&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="25">      &lt;/Suspense&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="26">      &lt;Suspense fallback={&lt;p&gt;Loading Weather Component&lt;/p&gt;}&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="27">        &lt;Weather /&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="28">      &lt;/Suspense&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="29">      &lt;Suspense fallback={&lt;p&gt;Loading Recommend Component&lt;/p&gt;}&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="30">        &lt;Recommend /&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="31">      &lt;/Suspense&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="32">    &lt;/section&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="33">  )</span>
<span class="code-block-extension-codeLine" data-line-num="34">}</span>
</code></pre>

In this example, we wrapped three components with Suspense and simulated the time it takes for data requests through the sleep function. The loading effect is as follows:

![suspense.gif](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/60be4c9076614e16934f26215a242841~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1449&h=507&s=269182&e=gif&f=26&b=1a1a1a)

But how does Next.js implement it?

Let's observe the loading of the dashboard HTML file. You will find that it starts at 2.03s, then becomes 5.03s, and finally becomes 8.04s. Isn't this exactly the sleep time we set?

View the response headers of the dashboard request:

![截屏2024-03-04 22.47.51.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b0d2d120619c4c74a494805105f1c717~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1866&h=956&s=245353&e=png&b=292929)

The `Transfer-Encoding` header has a value of `chunked`, indicating that the data will be sent in a series of chunks.

> Chunked transfer encoding is a data transfer mechanism in Hypertext Transfer Protocol (HTTP) that allows HTTP data sent by a web server to a client application (usually a web browser) to be divided into multiple parts . Chunked transfer encoding is only provided in HTTP protocol version 1.1 (HTTP/1.1).

Look at the data returned by the dashboard (we have simplified it here):

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div></div><code class="hljs language-html code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">&lt;!DOCTYPE html&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="2">&lt;html lang=&#34;en&#34;&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="3">    &lt;head&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="4">        // ...</span>
<span class="code-block-extension-codeLine" data-line-num="5">    &lt;/head&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="6">    &lt;body class=&#34;__className_aaf875&#34;&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="7">        &lt;section style=&#34;padding:20px&#34;&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="8">            &lt;!--$?--&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="9">            &lt;template id=&#34;B:0&#34;&gt;&lt;/template&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="10">            &lt;p&gt;Loading PostFeed Component&lt;/p&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="11">            &lt;!--/$--&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="12">            &lt;!--$?--&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="13">            &lt;template id=&#34;B:1&#34;&gt;&lt;/template&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="14">            &lt;p&gt;Loading Weather Component&lt;/p&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="15">            &lt;!--/$--&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="16">            &lt;!--$?--&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="17">            &lt;template id=&#34;B:2&#34;&gt;&lt;/template&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="18">            &lt;p&gt;Loading Recommend Component&lt;/p&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="19">            &lt;!--/$--&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="20">        &lt;/section&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="21">        // ...</span>
<span class="code-block-extension-codeLine" data-line-num="22">        &lt;div hidden id=&#34;S:0&#34;&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="23">            &lt;h1&gt;Hello PostFeed&lt;/h1&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="24">        &lt;/div&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="25">        &lt;script&gt;<span class="javascript"></span></span>
<span class="code-block-extension-codeLine" data-line-num="26">            // 交换位置</span>
<span class="code-block-extension-codeLine" data-line-num="27">            $RC = function(b, c, e) {</span>
<span class="code-block-extension-codeLine" data-line-num="28">                // ...</span>
<span class="code-block-extension-codeLine" data-line-num="29">            };</span>
<span class="code-block-extension-codeLine" data-line-num="30">            $RC(&#34;B:0&#34;, &#34;S:0&#34;)</span>
<span class="code-block-extension-codeLine" data-line-num="31">        &lt;/script&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="32">        &lt;div hidden id=&#34;S:2&#34;&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="33">            &lt;h1&gt;Hello Recommend&lt;/h1&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="34">        &lt;/div&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="35">        &lt;script&gt;<span class="javascript"></span></span>
<span class="code-block-extension-codeLine" data-line-num="36">            $RC(&#34;B:2&#34;, &#34;S:2&#34;)</span>
<span class="code-block-extension-codeLine" data-line-num="37">        &lt;/script&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="38">        &lt;div hidden id=&#34;S:1&#34;&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="39">            &lt;h1&gt;Hello Weather&lt;/h1&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="40">        &lt;/div&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="41">        &lt;script&gt;<span class="javascript"></span></span>
<span class="code-block-extension-codeLine" data-line-num="42">            $RC(&#34;B:1&#34;, &#34;S:1&#34;)</span>
<span class="code-block-extension-codeLine" data-line-num="43">        &lt;/script&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="44">    &lt;/body&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="45">&lt;/html&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="46"></span>
</code></pre>

You can see that the fallback UI and rendered content using the Suspense component will appear in the HTML file, indicating that the request continues to maintain a connection with the server. After the component is rendered, the server will append the rendered content to the client. , the client parses the new content after receiving it, and executes a function similar to `$RC("B:2", "S:2")` to exchange the DOM content, so that the fallback UI is replaced with the rendered content.

This process is called Streaming Server Rendering, and it solves the first problem of traditional SSR mentioned in the previous section, which is that data must be obtained before the component is rendered. Using Suspense, first render the Fallback UI, wait for the data to return, and then render the specific component content.

Another benefit of using Suspense is Selective Hydration. Simply put, when multiple components are waiting for hydration, React can determine the priority of component hydration based on user interaction. For example, both the Sidebar and MainContent components are waiting for hydration. The Sidebar is about to arrive, but at this time the user clicks on the MainContent component. React will synchronize the hydration of the MainContent component during the capture phase of the click event to ensure immediate response, and the Sidebar will be hydrated later.

To summarize, using Suspense, you can unlock two main benefits that make SSR even more powerful:

1. Streaming Server Rendering: Progressive rendering of HTML from server to client
2. Selective Hydration: React determines the priority of hydration based on user interaction

### Does Suspense affect SEO?

First, Next.js will wait for [generateMetadata](https://juejin.cn/book/7307859898316881957/section/7309079119902277669#heading-3 "https://juejin.cn/book/7307859898316881957/section/7309079119902277669#heading-3") After the data request is completed, the UI is streamed to the client, which ensures that the first part of the response will contain the `<head>` tag.

Secondly, because Streaming is streaming rendering, the HTML will contain the final rendered content, so it will not affect SEO.

### How does Suspense control the rendering order?

In the example just now, we are rendering three components at the same time. Whichever component's data is returned first will be rendered first.

But sometimes, you want to display components in a certain order, such as displaying `PostFeed` first, then `Weather`, and finally `Recommend`. At this time, you can nest the Suspense component:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">import { Suspense } from &#39;react&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="2"></span>
<span class="code-block-extension-codeLine" data-line-num="3">const sleep = ms =&gt; new Promise(r =&gt; setTimeout(r, ms));</span>
<span class="code-block-extension-codeLine" data-line-num="4"></span>
<span class="code-block-extension-codeLine" data-line-num="5">async function PostFeed() {</span>
<span class="code-block-extension-codeLine" data-line-num="6">  await sleep(2000)</span>
<span class="code-block-extension-codeLine" data-line-num="7">  return <span class="xml">&lt;h1&gt;Hello PostFeed&lt;/h1&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="8">}</span>
<span class="code-block-extension-codeLine" data-line-num="9"></span>
<span class="code-block-extension-codeLine" data-line-num="10">async function Weather() {</span>
<span class="code-block-extension-codeLine" data-line-num="11">  await sleep(8000)</span>
<span class="code-block-extension-codeLine" data-line-num="12">  return <span class="xml">&lt;h1&gt;Hello Weather&lt;/h1&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="13">}</span>
<span class="code-block-extension-codeLine" data-line-num="14"></span>
<span class="code-block-extension-codeLine" data-line-num="15">async function Recommend() {</span>
<span class="code-block-extension-codeLine" data-line-num="16">  await sleep(5000)</span>
<span class="code-block-extension-codeLine" data-line-num="17">  return <span class="xml">&lt;h1&gt;Hello Recommend&lt;/h1&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="18">}</span>
<span class="code-block-extension-codeLine" data-line-num="19"></span>
<span class="code-block-extension-codeLine" data-line-num="20">export default function Dashboard() {</span>
<span class="code-block-extension-codeLine" data-line-num="21">  return (</span>
<span class="code-block-extension-codeLine" data-line-num="22">    <span class="xml">&lt;section style={{padding: &#39;20px&#39;}}&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="23">      &lt;Suspense fallback={&lt;p&gt;Loading PostFeed Component&lt;/p&gt;}&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="24">        &lt;PostFeed /&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="25">        &lt;Suspense fallback={&lt;p&gt;Loading Weather Component&lt;/p&gt;}&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="26">          &lt;Weather /&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="27">          &lt;Suspense fallback={&lt;p&gt;Loading Recommend Component&lt;/p&gt;}&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="28">            &lt;Recommend /&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="29">          &lt;/Suspense&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="30">        &lt;/Suspense&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="31">      &lt;/Suspense&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="32">    &lt;/section&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="33">  )</span>
<span class="code-block-extension-codeLine" data-line-num="34">}</span>
</code></pre>

So the question is, how many seconds is the final loading time of the page at this time? Is the request taking the longest 8s or 2 + 8 + 5 = 15s? Let's see the effect:

![suspense1.gif](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/00bcbba3b76e48728dc4958076e82257~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1462&h=509&s=222364&e=gif&f=13&b=fcfcfc)

The answer is 8s. These data requests are sent at the same time, so when the Weather component returns, the Recommend component is displayed immediately.

Note: This is also because the data request here does not have any dependencies. If there is, then we will talk about it separately.
