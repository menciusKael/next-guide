##Preface

How to retrieve data in Next.js?

Next.js recommends using native fetch methods first, as Next.js extends native fetch methods by adding caching and updating cache (revalidation) mechanisms.

The advantage of doing this is that it can automatically reuse request data and improve performance. The downside is that if you are not familiar with it, there are often some inexplicable and wonderful situations that arise

Let's take a look at how to use it specifically.

##1 Using fetch on the server

###1.1 Basic Usage

Next.js extends the native [fetch Web API](https://link.juejin.cn/?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FFetch_API "https://developer.mozilla.org/zh-CN/docs/Web/API/Fetch_API")，Caching and revalidating behaviors can be configured for each request on the \* \* server.

You can use fetch with the syntax of 'async'/'await' in \* _ server-side components, routing handlers, and Server Actions _ \*.

For example:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div>></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">// app/page.js</span>
<span class="code-block-extension-codeLine" data-line-num="2">async function getData() {</span>
<span class="code-block-extension-codeLine" data-line-num="3">  const res = await fetch(&#39;https://jsonplaceholder.typicode.com/todos&#39;)</span>
<span class="code-block-extension-codeLine" data-line-num="4">  if (!res.ok) {</span>
<span class="code-block-extension-codeLine" data-line-num="5">    // Processed by the latest error. js</span>
<span class="code-block-extension-codeLine" data-line-num="6">    throw new Error(&#39;Failed to fetch data&#39;)</span>
<span class="code-block-extension-codeLine" data-line-num="7">  }</span>
<span class="code-block-extension-codeLine" data-line-num="8">  return res.json()</span>
<span class="code-block-extension-codeLine" data-line-num="9">}</span>
<span class="code-block-extension-codeLine" data-line-num="10"></span>
<span class="code-block-extension-codeLine" data-line-num="11">export default async function Page() {</span>
<span class="code-block-extension-codeLine" data-line-num="12">  const data = await getData()</span>
<span class="code-block-extension-codeLine" data-line-num="13">  return <span class="xml">&lt;main&gt;{JSON.stringify(data)}&lt;/main&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="14">}</span></code></pre>

###1.2 Default cache

By default, Next.js will automatically cache the return value of the server's' fetch 'request (using [Data Cache] behind it)

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">// The cache option of fetch is used to control the caching behavior of the request</span>
<span class="code-block-extension-codeLine" data-line-num="2">// The default is&# 39; force-cache&#39;,  You can omit it when writing normally</span>
<span class="code-block-extension-codeLine" data-line-num="3">fetch(&#39;https://...&#39;, { cache: &#39;force-cache&#39; })</span>
</code></pre>

But these situations do not automatically cache by default:

When using in Server Action
When used in routing handlers that define non GET methods

**Simply put, using fetch in server-side components and routing handlers with only GET methods will automatically cache the returned results**

####1.2.1 Logging configuration item

Let's give each example to demonstrate. But before writing the code, let's first modify the configuration of 'next. config. mjs':

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-js code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">const nextConfig = {</span>
<span class="code-block-extension-codeLine" data-line-num="2">  logging: {</span>
<span class="code-block-extension-codeLine" data-line-num="3">    fetches: {</span>
<span class="code-block-extension-codeLine" data-line-num="4">      fullUrl: true</span>
<span class="code-block-extension-codeLine" data-line-num="5">    }</span>
<span class="code-block-extension-codeLine" data-line-num="6">  }</span>
<span class="code-block-extension-codeLine" data-line-num="7">};</span>
<span class="code-block-extension-codeLine" data-line-num="8"></span>
<span class="code-block-extension-codeLine" data-line-num="9">export default nextConfig;</span>
</code></pre>

At present, there is only one configuration for logging, which is used to display fetch requests and cache logs in development mode:

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/76fca0ddd8f54a12bae3b9a0f6487f90~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1078&h=78&s=71180&e=png&b=070314)

The meaning of the log above is:

Accessing the '/API/cache' route, where GET requested [dog.ceo/api/breeds/…](https://link.juejin.cn/?target=https%3A%2F%2Fdog.ceo%2Fapi%2Fbreeds%2Fimage%2Frandom "https://dog.ceo/api/breeds/image/random") This interface, The interface returns after 20ms, with a status code of 200. This request has hit the cache (HIT).

This log will help us check the cache situation (some log results may not be very accurate during actual use, and there is still room for improvement).

####1.2.2 Server components

The first method is used in server-side components, modify 'app/page. js', and the code is as follows:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-js code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">async function getData() {</span>
<span class="code-block-extension-codeLine" data-line-num="2">  // The interface returns a random cat image data every time it is called</span>
<span class="code-block-extension-codeLine" data-line-num="3">  const res = await fetch(&#39;https://api.thecatapi.com/v1/images/search&#39;)</span>
<span class="code-block-extension-codeLine" data-line-num="4">  if (!res.ok) {</span>
<span class="code-block-extension-codeLine" data-line-num="5">    throw new Error(&#39;Failed to fetch data&#39;)</span>
<span class="code-block-extension-codeLine" data-line-num="6">  }</span>
<span class="code-block-extension-codeLine" data-line-num="7"></span>
<span class="code-block-extension-codeLine" data-line-num="8">  return res.json()</span>
<span class="code-block-extension-codeLine" data-line-num="9">}</span>
<span class="code-block-extension-codeLine" data-line-num="10"></span>
<span class="code-block-extension-codeLine" data-line-num="11">export default async function Page() {</span>
<span class="code-block-extension-codeLine" data-line-num="12">  const data = await getData()</span>
<span class="code-block-extension-codeLine" data-line-num="13"></span>
<span class="code-block-extension-codeLine" data-line-num="14">  return <span class="xml">&lt;img src={data[0].url} width=&#34;300&#34; /&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="15">}</span>
</code></pre>

Run 'npm run dev' to enable development mode:

![cache-4.gif](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/09ea27349964498e81fc2a196ae174c8~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1436&h=459&s=466881&e=gif&f=39&b=180831)

In development mode, for the convenience of debugging, you can use the browser's hard refresh (Command+Shift+R) to clear the cache, at which point the data will change (cache: SKIP). When refreshing normally, the data will remain unchanged because it will hit the cache (HIT).

Run 'npm run build&&npm run start' to start the production version:

![cache.gif](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e26d6e09a5e04b99bba03a8a1f9d8141~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=439&h=353&s=136348&e=gif&f=33&b=efedec)

Because the return result of the fetch request is cached, the image data will remain unchanged regardless of whether it is hard refreshed or not.

####1.2.3 Route handler GET request

The second method is used in the routing processing program, creating a new 'app/API/cache/route. js' with the following code:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-js code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">export async function GET() {</span>
<span class="code-block-extension-codeLine" data-line-num="2">  const res = await fetch(&#39;https://dog.ceo/api/breeds/image/random&#39;)</span>
<span class="code-block-extension-codeLine" data-line-num="3"></span>
<span class="code-block-extension-codeLine" data-line-num="4">  const data = await res.json()</span>
<span class="code-block-extension-codeLine" data-line-num="5">  return Response.json({ data })</span>
<span class="code-block-extension-codeLine" data-line-num="6">}</span>
</code></pre>

Run 'npm run dev' to enable development mode:

![cache-5.gif](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3c844d6e5ce04083b81e5797241b7494~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1436&h=459&s=293876&e=gif&f=40&b=141414)

In development mode, when the browser is hard refreshed, it will skip the cache, and when it is normal refreshed, it will hit the cache. It can be seen that during the first hard refresh, the request interface time was 912ms. However, during the subsequent normal refresh, due to the use of cached data, the data return time was around 1ms.

Run 'npm run build&&npm run start' to start the production version:

![cache-6.gif](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a5d4476224694a73a8f631359cd2ead6~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1036&h=192&s=53493&e=gif&f=31&b=191919)

Because the return result of the fetch request is cached, the interface data will remain unchanged regardless of whether it is hard refreshed or not.
