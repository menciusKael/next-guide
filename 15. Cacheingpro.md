##Preface

In this article, we will continue to discuss the caching mechanism of Next.js. Today we will introduce the complete routing cache and routing cache.

##1 Full Route Cache

###1.1 operational principle

Next.js will automatically render and cache routes during \* \* construction, so that when accessing routes, the cached routes can be directly used instead of rendering from scratch on the server, thereby accelerating page loading speed.

So you might ask, what kind of ghost is cache routing? I have heard of caching data, but how do routers cache it? Let's review the rendering principles of Next.js:

Next.js uses React's API to orchestrate rendering. When rendering, the rendering work will be split into multiple chunks based on routing and Suspension, and each chunk will be rendered in two steps:

1. React will render server-side components into a special data format, which we call React Server Component Payload, abbreviated as RSC Payload. For example, the code for a server-side component is:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">&lt;div&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="2">  Don’t give up and don’t give in.</span>
<span class="code-block-extension-codeLine" data-line-num="3">  &lt;ClientComponent /&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="4">&lt;/div&gt;</span>
</code></pre>

React will convert it to the following Payload:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">[&#34;$&#34;,&#34;div&#34;,null,{&#34;children&#34;:[&#34;Don’t give up and don’t give in.&#34;, [&#34;$&#34;,&#34;$L1&#34;,null,{}]]}]</span>
<span class="code-block-extension-codeLine" data-line-num="2">1:I{&#34;id&#34;:123,&#34;chunks&#34;:[&#34;chunk/[hash].js&#34;],&#34;name&#34;:&#34;ClientComponent&#34;,&#34;async&#34;:false}</span>
</code></pre>

This format is optimized for streams, which can be sent line by line from the server to the client in the form of streams. The client can parse the RSC Payload line by line and gradually render the page.

Of course, this RSC payload code cannot be executed directly, as it contains more information:

1. The rendering results of server-side components
2. Placeholders and reference files of client components
3. Data passed from server-side components to client-side components

For example, the '$L1' in this RSC payload represents the ClientComponent. After receiving the RSC payload, the client will parse and download the bundle address corresponding to the ClientComponent, and then render the execution result to the position occupied by the '$L1'.

2. Next.js will use RSC payload and client component code to render HTML on the server side

This picture vividly depicts the process:

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/eb119007336543c288845f29c425e014~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1600&h=888&s=171366&e=png&b=0d0d0d)

Simply put, there are two products of routing rendering, one is RSC Payload and the other is HTML. The complete routing cache contains these two products.

However, whether the route will be cached during construction depends on whether it is static or dynamic rendering. Static routes are cached by default, while dynamic routes are not cached because they can only be rendered at the time of a request. This image shows the difference between static rendering and dynamic rendering:

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/27d1e45c1c5849d2892dfad986832acc~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1600&h=1314&s=351817&e=png&b=0c0c0c)

In this diagram, the static route '/a' will not be re rendered because it has a complete route cache. Dynamic routing '/b' does not have a complete routing cache, so it will be re rendered. But this does not affect the client's routing cache, so the routing cache is hit in subsequent requests.

###1.2 Duration

The complete routing cache is persistent by default, which means it can be reused across user requests.

###1.3 Failure mode

There are two ways to invalidate the complete routing cache:

*Revalidating data: revalidating the data cache will invalidate the complete routing cache, as rendering output depends on data
*Redeployment: Data caching can be cross deployed, but the complete routing cache will be cleared during redeployment

###1.4 Exit method

The way to exit the complete routing cache is to change it to dynamic rendering:

*Using dynamic functions: After using dynamic functions, it will be changed to dynamic rendering, and the data cache can still be used at this time
*Using the routing segment configuration option: 'dynamic='force dynamic' or 'validate=0' will skip the full routing cache and data cache, meaning that the data will be retrieved and the component will be rendered every time a request is made. At this point, the routing cache can still be used, as it is the client cache
\*Exiting data cache: If a fetch request in the route exits the cache, the complete route cache will be exited. This specific fetch request will be retrieved on each request, while other fetch requests will still use data caching. Next.js allows for a mixture of cached and uncached data

Simply put, the complete routing cache is only applicable to static rendering, and the products of static rendering, RSC Payload and HTML, are retained on the server.

Using dynamic rendering will exit the full routing cache. How to transition routing from static rendering to dynamic rendering, you can also refer to[](https://juejin.cn/book/7307859898316881957/section/7342031804771565619#heading-2 "https://juejin.cn/book/7307859898316881957/section/7342031804771565619#heading-2")。

## 2. Router Cache

###2.1 operational principle

Next.js has a client cache stored in memory, which stores RSC Payloads by routing segment during user sessions. This is the routing cache.

The working principle diagram is as follows:

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8964c9aa0318409db0dd74ed86d18dd6~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1600&h=1375&s=312833&e=png&b=0b0b0b)

The schematic diagram is easy to understand. When accessing '/a', as it is the first time accessing (MISS'), the '/(layout)' and '/a (page)' are placed in the routing cache (SET '). When accessing'/b 'that shares the layout with'/a ', the'/(layout) 'in the routing cache is used, and then the'/b (page) 'is placed in the routing cache (SET'). When accessing '/a' again, directly use the '/(layout)' and '/b (page)' in the routing cache (HIT ').

Moreover, when a user navigates between routes, Next.js will cache the visited route segments and pre fetch the routes that the user may navigate (based on the 'Link>' component within the viewport). This will bring users a better navigation experience:

1. Instant forward and backward navigation, as visited routes have already been cached and new routes have been pre acquired
2. Navigation will not cause page overload and will retain the React and browser states

Let's write a demo based on the schematic to verify:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">// app/layout.js</span>
<span class="code-block-extension-codeLine" data-line-num="2">import Link from &#34;next/link&#34;;</span>
<span class="code-block-extension-codeLine" data-line-num="3"></span>
<span class="code-block-extension-codeLine" data-line-num="4">export default function RootLayout({ children }) {</span>
<span class="code-block-extension-codeLine" data-line-num="5">  return (</span>
<span class="code-block-extension-codeLine" data-line-num="6">    <span class="xml">&lt;html lang=&#34;en&#34;&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="7">      &lt;body&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="8">        &lt;div&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="9">          &lt;Link href=&#34;/a&#34;&gt;Link to /a&lt;/Link&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="10">          &lt;br /&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="11">          &lt;Link href=&#34;/b&#34;&gt;Link to /b&lt;/Link&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="12">        &lt;/div&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="13">        {children}</span>
<span class="code-block-extension-codeLine" data-line-num="14">      &lt;/body&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="15">    &lt;/html&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="16">  )</span>
<span class="code-block-extension-codeLine" data-line-num="17">}</span>
</code></pre>

The codes for the two routes are similar:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">// app/a/page.js | app/b/page.js</span>
<span class="code-block-extension-codeLine" data-line-num="2">export default function Page() {</span>
<span class="code-block-extension-codeLine" data-line-num="3">  return (</span>
<span class="code-block-extension-codeLine" data-line-num="4">    <span class="xml">&lt;h1&gt;Component X&lt;/h1&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="5">  )</span>
<span class="code-block-extension-codeLine" data-line-num="6">}</span>
</code></pre>

When accessing '/a' for the first time, because the '/a' and '/b' of the Link component are both in the viewport, the RSC payload for '/a' and '/b' will be preloaded:

![2023-11-28 上午11.13.19.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/73175e3be51847c7bfb65e00c32da591~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1298&h=1028&s=150651&e=png&b=ffffff)

Thanks to preloading and caching, both navigation and forward/backward are very smooth:

![1114.gif](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4a18d51d4ff7448d81b2e883b223b73f~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=927&h=570&s=131584&e=gif&f=32&b=fefefe)

###2.2 Duration

The routing cache is stored in the temporary cache of the browser, and two factors determine the duration of the routing cache:

*Session, cache persists during navigation and is cleared when the page is refreshed
*Automatic expiration period: A single routing segment will automatically expire after a specific amount of time
*If the route is static rendering, lasting for 5 minutes\*\*
*If the route is dynamically rendered and lasts for 30 seconds\*\*

For example, in the demo above, if you wait for 5 minutes before clicking, you will retrieve a new RSC Payload

By adding 'prefetch={true}' (the prefetch of the Link component is true by default) or calling 'router. prefetch' in the dynamic rendering route, you can enter the cache for 5 minutes.

###2.3 Failure mode

**There are two ways to invalidate the routing cache:**

*In Server Action
*Verify the data again through either 'revolidatePath' or 'revolidateTag'
*Using 'cookies. set' or 'cookies. delete' will invalidate the routing cache, which is to prevent routes that use cookies from becoming outdated (such as authentication)
*Calling 'router. refresh' will invalidate the routing cache and initiate a request to retrieve the current route again

###2.4 Exit method

\*_Unable to exit routing cache _ \*. You can exit pre fetch by passing 'false' to the 'prefetch' component of the '<Link>' component, but the routing segments will still be temporarily stored for 30 seconds to achieve real-time navigation between nested routing segments. In addition, accessed routes will also be cached.

###2.5 Practical experience

At this point, you may think that routing caching is pretty good, but let's write a project and experience how routing caching can sometimes be a headache in practice!

The directory structure is as follows:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-scss code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">app                  </span>
<span class="code-block-extension-codeLine" data-line-num="2">├─ (cache)       </span>
<span class="code-block-extension-codeLine" data-line-num="3">│  ├─ about          </span>
<span class="code-block-extension-codeLine" data-line-num="4">│  │  └─ page.js     </span>
<span class="code-block-extension-codeLine" data-line-num="5">│  ├─ settings       </span>
<span class="code-block-extension-codeLine" data-line-num="6">│  │  └─ page.js     </span>
<span class="code-block-extension-codeLine" data-line-num="7">│  ├─ layout.js      </span>
<span class="code-block-extension-codeLine" data-line-num="8">│  └─ loading.js         </span>
</code></pre>

The code for 'app/(cache)/layout. js' is as follows:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-js code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">import Link from &#39;next/link&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="2"></span>
<span class="code-block-extension-codeLine" data-line-num="3">export const dynamic = &#39;force-dynamic&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="4"></span>
<span class="code-block-extension-codeLine" data-line-num="5">export default function CacheLayout({</span>
<span class="code-block-extension-codeLine" data-line-num="6">  children,</span>
<span class="code-block-extension-codeLine" data-line-num="7">}) {</span>
<span class="code-block-extension-codeLine" data-line-num="8">  return (</span>
<span class="code-block-extension-codeLine" data-line-num="9">    <span class="xml">&lt;section className=&#34;p-5&#34;&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="10">        &lt;nav className=&#34;flex items-center justify-center gap-10 text-blue-600 mb-6&#34;&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="11">          &lt;Link href=&#34;/about&#34;&gt;About&lt;/Link&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="12">          &lt;Link href=&#34;/settings&#34;&gt;Settings&lt;/Link&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="13">        &lt;/nav&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="14">      {children}</span>
<span class="code-block-extension-codeLine" data-line-num="15">    &lt;/section&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="16">  )</span>
<span class="code-block-extension-codeLine" data-line-num="17">}</span>
</code></pre>

`app/(cache)/loading.js`，The code is as follows:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-js code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">export default function DashboardLoading() {</span>
<span class="code-block-extension-codeLine" data-line-num="2">  return  <span class="xml">&lt;div className=&#34;h-60 flex-1 rounded-xl bg-indigo-500 text-white flex items-center justify-center&#34;&gt;Loading&lt;/div&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="3">}</span>
</code></pre>

`app/(cache)/about/page.js`，The code is as follows:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-js code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">const sleep = ms =&gt; new Promise(r =&gt; setTimeout(r, ms));</span>
<span class="code-block-extension-codeLine" data-line-num="2"></span>
<span class="code-block-extension-codeLine" data-line-num="3">export default async function About() {</span>
<span class="code-block-extension-codeLine" data-line-num="4">  await sleep(2000)</span>
<span class="code-block-extension-codeLine" data-line-num="5">  return (</span>
<span class="code-block-extension-codeLine" data-line-num="6">    <span class="xml">&lt;div className=&#34;h-60 flex-1 rounded-xl bg-teal-400 text-white flex items-center justify-center&#34;&gt;Hello, About! {new Date().toLocaleString()}&lt;/div&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="7">  )</span>
<span class="code-block-extension-codeLine" data-line-num="8">}</span>
</code></pre>

`app/(cache)/settings/page.js`，The code is as follows:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-js code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">const sleep = ms =&gt; new Promise(r =&gt; setTimeout(r, ms));</span>
<span class="code-block-extension-codeLine" data-line-num="2"></span>
<span class="code-block-extension-codeLine" data-line-num="3">export default async function Settings() {</span>
<span class="code-block-extension-codeLine" data-line-num="4">  await sleep(2000)</span>
<span class="code-block-extension-codeLine" data-line-num="5">  return (</span>
<span class="code-block-extension-codeLine" data-line-num="6">    <span class="xml">&lt;div className=&#34;h-60 flex-1 rounded-xl bg-teal-400 text-white flex items-center justify-center&#34;&gt;Hello, Settings! {new Date().toLocaleString()}&lt;/div&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="7">  )</span>
<span class="code-block-extension-codeLine" data-line-num="8">}</span>
</code></pre>

Run the production version with the following interactive effects:

![cache-13.gif](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2ca548ee77b444eb96e34b8d868d3738~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1235&h=800&s=1605366&e=gif&f=66&b=262829)

The interaction effect looks normal, doesn't it? However, please note:

When we refresh the page, '/about' shows loading, and when we first click on Settings to navigate to '/settings', it also shows loading. However, when we click on About and Settings again, there is no loading effect. Moreover, when checking network requests, we do not even send them.

This is the effectiveness of client routing caching. Especially when paired with tag navigation, RSC is directly obtained from the routing cache, so even the time remains unchanged during navigation.

What if I want to reload the page every time I click?

You may think, then add routing section configuration items such as' dynamic 'and' validate 'to the About and Settings pages to convert static rendering to dynamic rendering. But in fact, we have already configured 'const dynamic='force dynamic' in the layout, and now it is dynamic rendering. Dynamic rendering can only make the page refresh or the first request time accurate, but navigation will still not be updated due to client caching.

So what should we do?

The first way is to wait. The client cache has an automatic expiration period, with dynamic rendering lasting for 30 seconds and static rendering lasting for 5 minutes. Now it's dynamic rendering, wait for 30 seconds before clicking on About and Settings to resend the request and display the correct time.

The second way is to use the native '<a>' tag instead of the Link tag. However, this method will cause the page to refresh.

Modify 'app/(cache)/layout. js' with the following code:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-js code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">import Link from &#39;next/link&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="2"></span>
<span class="code-block-extension-codeLine" data-line-num="3">export const dynamic = &#39;force-dynamic&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="4"></span>
<span class="code-block-extension-codeLine" data-line-num="5">export default function CacheLayout({</span>
<span class="code-block-extension-codeLine" data-line-num="6">  children,</span>
<span class="code-block-extension-codeLine" data-line-num="7">}) {</span>
<span class="code-block-extension-codeLine" data-line-num="8">  return (</span>
<span class="code-block-extension-codeLine" data-line-num="9">    <span class="xml">&lt;section className=&#34;p-5&#34;&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="10">        &lt;nav className=&#34;flex items-center justify-center gap-10 text-blue-600 mb-6&#34;&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="11">          &lt;a href=&#34;/about&#34;&gt;About&lt;/a&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="12">          &lt;a href=&#34;/settings&#34;&gt;Settings&lt;/a&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="13">        &lt;/nav&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="14">      {children}</span>
<span class="code-block-extension-codeLine" data-line-num="15">    &lt;/section&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="16">  )</span>
<span class="code-block-extension-codeLine" data-line-num="17">}</span>
</code></pre>

Run the production version with the following interactive effects:

![cache-14.gif](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/caeac218e1314bdf86c464f6534eecfb~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1235&h=800&s=650141&e=gif&f=46&b=292929)

The third way is to refer to the method of invalidating the routing cache: one is to use Server Actions, but we cannot use Server Actions here. One way is to call router. refresh, but using router requires declaring it as a client component, which requires changing the layout to a client component. Although it may be a bit bad, it can still be used.

Modify 'app/(cache)/layout. js' with the following code:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-js code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">&#39;use client&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="2"></span>
<span class="code-block-extension-codeLine" data-line-num="3">import { useRouter } from &#39;next/navigation&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="4"></span>
<span class="code-block-extension-codeLine" data-line-num="5">export default function CacheLayout({</span>
<span class="code-block-extension-codeLine" data-line-num="6">  children,</span>
<span class="code-block-extension-codeLine" data-line-num="7">}) {</span>
<span class="code-block-extension-codeLine" data-line-num="8">  const router = useRouter()</span>
<span class="code-block-extension-codeLine" data-line-num="9">  return (</span>
<span class="code-block-extension-codeLine" data-line-num="10">    <span class="xml">&lt;section className=&#34;p-5&#34;&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="11">        &lt;nav className=&#34;flex items-center justify-center gap-10 text-blue-600 mb-6&#34;&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="12">          &lt;button onClick={() =&gt; {</span>
<span class="code-block-extension-codeLine" data-line-num="13">            router.push(&#39;/about&#39;)</span>
<span class="code-block-extension-codeLine" data-line-num="14">            router.refresh()</span>
<span class="code-block-extension-codeLine" data-line-num="15">          }}&gt;About&lt;/button&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="16">          &lt;button onClick={() =&gt; {</span>
<span class="code-block-extension-codeLine" data-line-num="17">            router.push(&#39;/settings&#39;)</span>
<span class="code-block-extension-codeLine" data-line-num="18">            router.refresh()</span>
<span class="code-block-extension-codeLine" data-line-num="19">          }}&gt;Settings&lt;/button&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="20">        &lt;/nav&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="21">      {children}</span>
<span class="code-block-extension-codeLine" data-line-num="22">    &lt;/section&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="23">  )</span>
<span class="code-block-extension-codeLine" data-line-num="24">}</span>
</code></pre>

Then add code to 'app/(cache)/about/page. js' and' app/(cache)/about/page. js':

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-js code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">export const dynamic = &#39;force-dynamic&#39;</span>
</code></pre>

The purpose is to turn it into dynamic rendering. Run the production version with the following results:

![cache-16.gif](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/282410b6f48443218699d266c1328161~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1235&h=800&s=751814&e=gif&f=53&b=2a2a2a)

The fourth and third methods both use router. refresh, but the implementation method is different. The example code is as follows:

Create a new 'app/(cache)/navigation events. js' with the following code:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-js code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">&#39;use client&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="2"></span>
<span class="code-block-extension-codeLine" data-line-num="3">import { useEffect } from &#39;react&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="4">import { usePathname, useSearchParams } from &#39;next/navigation&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="5">import { useRouter } from &#39;next/navigation&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="6"></span>
<span class="code-block-extension-codeLine" data-line-num="7">export function NavigationEvents() {</span>
<span class="code-block-extension-codeLine" data-line-num="8">  const pathname = usePathname()</span>
<span class="code-block-extension-codeLine" data-line-num="9">  const searchParams = useSearchParams()</span>
<span class="code-block-extension-codeLine" data-line-num="10">  const router = useRouter()</span>
<span class="code-block-extension-codeLine" data-line-num="11"></span>
<span class="code-block-extension-codeLine" data-line-num="12">  useEffect(() =&gt; {</span>
<span class="code-block-extension-codeLine" data-line-num="13">    router.refresh()</span>
<span class="code-block-extension-codeLine" data-line-num="14">  }, [pathname, searchParams])</span>
<span class="code-block-extension-codeLine" data-line-num="15"></span>
<span class="code-block-extension-codeLine" data-line-num="16">  return null</span>
<span class="code-block-extension-codeLine" data-line-num="17">}</span>
</code></pre>

Modify 'app/(cache)/layout. js' with the following code:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-js code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">import Link from &#39;next/link&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="2">import { Suspense } from &#39;react&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="3">import { NavigationEvents } from &#39;./navigation-events&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="4"></span>
<span class="code-block-extension-codeLine" data-line-num="5">export const dynamic = &#39;force-dynamic&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="6"></span>
<span class="code-block-extension-codeLine" data-line-num="7">export default function CacheLayout({</span>
<span class="code-block-extension-codeLine" data-line-num="8">  children,</span>
<span class="code-block-extension-codeLine" data-line-num="9">}) {</span>
<span class="code-block-extension-codeLine" data-line-num="10">  return (</span>
<span class="code-block-extension-codeLine" data-line-num="11">    <span class="xml">&lt;section className=&#34;p-5&#34;&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="12">        &lt;nav className=&#34;flex items-center justify-center gap-10 text-blue-600 mb-6&#34;&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="13">          &lt;Link href={`/about`}&gt;About&lt;/Link&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="14">          &lt;Link href={`/settings`}&gt;Settings&lt;/Link&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="15">        &lt;/nav&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="16">      {children}</span>
<span class="code-block-extension-codeLine" data-line-num="17">      &lt;Suspense fallback={null}&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="18">        &lt;NavigationEvents /&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="19">      &lt;/Suspense&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="20">    &lt;/section&gt;</span>
<span class="code-block-extension-codeLine" data-line-num="21">  )</span>
<span class="code-block-extension-codeLine" data-line-num="22">}</span>
</code></pre>

Run the production version with the following interactive effects:

![cache-15.gif](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/52a49095ee07425ba2eeb47f66ab2349~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1235&h=800&s=1232048&e=gif&f=47&b=2a2a2a)

##Summary

The difference between routing cache and full routing cache:

1. The routing cache occurs during user access, temporarily storing the RSC Payload in the browser during navigation and will persist until the page is refreshed. And the complete routing cache will persistently cache RSC Payload and HTML on the server
2. The complete routing cache only caches routes that are statically rendered, and routing caching can be applied to routes that are statically and dynamically rendered

In actual project development, routing caching may be a headache inducing issue. Because it is frequently used but cannot be exited, special handling is sometimes required, so you can pay more attention to routing caching. Our first project in the practical part[](https://juejin.cn/book/7307859898316881957/section/7309112043122196490#heading-4 "https://juejin.cn/book/7307859898316881957/section/7309112043122196490#heading-4")You will also encounter routing caching.

As mentioned before, Next.js will automatically manage the cache based on the API you use. The specific relationship table between the API and the four types of caches is as follows:

| API                                                                                                                                                                                                                                                                                         | Routing cache              | Full routing cache    | Data cache            | Request memory |
| ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------- | --------------------- | --------------------- | -------------- |
| [``](https://link.juejin.cn/?target=https%3A%2F%2Fnextjs.org%2Fdocs%2Fapp%2Fbuilding-your-application%2Fcaching%23link "https://nextjs.org/docs/app/building-your-application/caching#link")                                                                                                | Cache                      |                       |                       |                |
| [`router.prefetch`](https://link.juejin.cn/?target=https%3A%2F%2Fnextjs.org%2Fdocs%2Fapp%2Fbuilding-your-application%2Fcaching%23routerprefetch "https://nextjs.org/docs/app/building-your-application/caching#routerprefetch")                                                             | Cache                      |                       |                       |                |
| [`router.refresh`](https://link.juejin.cn/?target=https%3A%2F%2Fnextjs.org%2Fdocs%2Fapp%2Fbuilding-your-application%2Fcaching%23routerrefresh "https://nextjs.org/docs/app/building-your-application/caching#routerrefresh")                                                                | Revalidate                 |                       |                       |                |
| [`fetch`](https://link.juejin.cn/?target=https%3A%2F%2Fnextjs.org%2Fdocs%2Fapp%2Fbuilding-your-application%2Fcaching%23fetch "https://nextjs.org/docs/app/building-your-application/caching#fetch")                                                                                         |                            |                       | Cache                 | Cache          |
| [`fetch` `options.cache`](https://link.juejin.cn/?target=https%3A%2F%2Fnextjs.org%2Fdocs%2Fapp%2Fbuilding-your-application%2Fcaching%23fetch-optionscache "https://nextjs.org/docs/app/building-your-application/caching#fetch-optionscache")                                               |                            |                       | Cache or Opt out      |                |
| [`fetch` `options.next.revalidate`](https://link.juejin.cn/?target=https%3A%2F%2Fnextjs.org%2Fdocs%2Fapp%2Fbuilding-your-application%2Fcaching%23fetch-optionsnextrevalidate "https://nextjs.org/docs/app/building-your-application/caching#fetch-optionsnextrevalidate")                   |                            | Revalidate            | Revalidate            |                |
| [`fetch` `options.next.tags`](https://link.juejin.cn/?target=https%3A%2F%2Fnextjs.org%2Fdocs%2Fapp%2Fbuilding-your-application%2Fcaching%23fetch-optionsnexttags-and-revalidatetag "https://nextjs.org/docs/app/building-your-application/caching#fetch-optionsnexttags-and-revalidatetag") |                            | Cache                 | Cache                 |                |
| [`revalidateTag`](https://link.juejin.cn/?target=https%3A%2F%2Fnextjs.org%2Fdocs%2Fapp%2Fbuilding-your-application%2Fcaching%23fetch-optionsnexttags-and-revalidatetag "https://nextjs.org/docs/app/building-your-application/caching#fetch-optionsnexttags-and-revalidatetag")             | Revalidate (Server Action) | Revalidate            | Revalidate            |                |
| [`revalidatePath`](https://link.juejin.cn/?target=https%3A%2F%2Fnextjs.org%2Fdocs%2Fapp%2Fbuilding-your-application%2Fcaching%23revalidatepath "https://nextjs.org/docs/app/building-your-application/caching#revalidatepath")                                                              | Revalidate (Server Action) | Revalidate            | Revalidate            |                |
| [`const revalidate`](https://link.juejin.cn/?target=https%3A%2F%2Fnextjs.org%2Fdocs%2Fapp%2Fbuilding-your-application%2Fcaching%23segment-config-options "https://nextjs.org/docs/app/building-your-application/caching#segment-config-options")                                            |                            | Revalidate or Opt out | Revalidate or Opt out |                |
| [`const dynamic`](https://link.juejin.cn/?target=https%3A%2F%2Fnextjs.org%2Fdocs%2Fapp%2Fbuilding-your-application%2Fcaching%23segment-config-options "https://nextjs.org/docs/app/building-your-application/caching#segment-config-options")                                               |                            | Cache or Opt out      | Cache or Opt out      |                |
| [`cookies`](https://link.juejin.cn/?target=https%3A%2F%2Fnextjs.org%2Fdocs%2Fapp%2Fbuilding-your-application%2Fcaching%23cookies "https://nextjs.org/docs/app/building-your-application/caching#cookies")                                                                                   | Revalidate (Server Action) | Opt out               |                       |                |
| [`headers`,`searchParams`](https://link.juejin.cn/?target=https%3A%2F%2Fnextjs.org%2Fdocs%2Fapp%2Fbuilding-your-application%2Fcaching%23dynamic-functions "https://nextjs.org/docs/app/building-your-application/caching#dynamic-functions")                                                |                            | Opt out               |                       |                |
| [`generateStaticParams`](https://link.juejin.cn/?target=https%3A%2F%2Fnextjs.org%2Fdocs%2Fapp%2Fbuilding-your-application%2Fcaching%23generatestaticparams "https://nextjs.org/docs/app/building-your-application/caching#generatestaticparams")                                            |                            | Cache                 |                       |                |
| [`React.cache`](https://link.juejin.cn/?target=https%3A%2F%2Fnextjs.org%2Fdocs%2Fapp%2Fbuilding-your-application%2Fcaching%23react-cache-function "https://nextjs.org/docs/app/building-your-application/caching#react-cache-function")                                                     |                            |                       |                       | Cache          |

Note: Cache indicates triggering cache, Revalidate indicates triggering revalidation, and Opt out indicates triggering cache exit

When encountering cache issues in development projects, you can first determine the type of cache involved based on the API used, and then choose an appropriate method to revalidate or exit the cache.
