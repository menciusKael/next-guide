## Preface

Next.js can be configured through `next.config.js` in the root directory:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div><span class="code-block-extension-lang">javascript</span></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">/** @type {import(&#39;next&#39;).NextConfig} */</span>
<span class="code-block-extension-codeLine" data-line-num="2">const nextConfig = {</span>
<span class="code-block-extension-codeLine" data-line-num="3">  /* config options here */</span>
<span class="code-block-extension-codeLine" data-line-num="4">}</span>
<span class="code-block-extension-codeLine" data-line-num="5"></span>
<span class="code-block-extension-codeLine" data-line-num="6">module.exports = nextConfig</span>
</code></pre>

As the file extension is `.js`, `next.config.js` is a regular Node.js module, not a JSON file. It is used during the Next.js server and build phases, and is not included in the browser build (the code is not bundled to the client).

If you need ECMAScript modules, you can use `next.config.mjs`:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div><span class="code-block-extension-lang">javascript</span></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">/**</span>
<span class="code-block-extension-codeLine" data-line-num="2"> * @type {import(&#39;next&#39;).NextConfig}</span>
<span class="code-block-extension-codeLine" data-line-num="3"> */</span>
<span class="code-block-extension-codeLine" data-line-num="4">const nextConfig = {</span>
<span class="code-block-extension-codeLine" data-line-num="5">  /* config options here */</span>
<span class="code-block-extension-codeLine" data-line-num="6">}</span>
<span class="code-block-extension-codeLine" data-line-num="7"></span>
<span class="code-block-extension-codeLine" data-line-num="8">export default nextConfig</span>
</code></pre>

You can also use a function:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div><span class="code-block-extension-lang">javascript</span></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">export default (phase, { defaultConfig }) =&gt; {</span>
<span class="code-block-extension-codeLine" data-line-num="2">  /**</span>
<span class="code-block-extension-codeLine" data-line-num="3">   * @type {import(&#39;next&#39;).NextConfig}</span>
<span class="code-block-extension-codeLine" data-line-num="4">   */</span>
<span class="code-block-extension-codeLine" data-line-num="5">  const nextConfig = {</span>
<span class="code-block-extension-codeLine" data-line-num="6">    /* config options here */</span>
<span class="code-block-extension-codeLine" data-line-num="7">  }</span>
<span class="code-block-extension-codeLine" data-line-num="8">  return nextConfig</span>
<span class="code-block-extension-codeLine" data-line-num="9">}</span>
</code></pre>

As of Next.js 12.1.0, you can also use an async function:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div><span class="code-block-extension-lang">javascript</span></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">module.exports = async (phase, { defaultConfig }) =&gt; {</span>
<span class="code-block-extension-codeLine" data-line-num="2">  /**</span>
<span class="code-block-extension-codeLine" data-line-num="3">   * @type {import(&#39;next&#39;).NextConfig}</span>
<span class="code-block-extension-codeLine" data-line-num="4">   */</span>
<span class="code-block-extension-codeLine" data-line-num="5">  const nextConfig = {</span>
<span class="code-block-extension-codeLine" data-line-num="6">    /* config options here */</span>
<span class="code-block-extension-codeLine" data-line-num="7">  }</span>
<span class="code-block-extension-codeLine" data-line-num="8">  return nextConfig</span>
<span class="code-block-extension-codeLine" data-line-num="9">}</span>
</code></pre>

Among them, `phase` represents the current context of configuration loading. By [viewing the source code](https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fvercel%2Fnext.js%2Fblob%2F5e6b008b561caf2710ab7be63320a3d549474a5b%2Fpackages%2Fnext%2Fshared%2Flib%2Fconstants.ts%23L19-L23 "https://github.com/vercel/next.js/blob/5e6b008b561caf2710ab7be63320a3d549474a5b/packages/next/shared/lib/constants.ts#L19-L23"), you can know that there are 5 values ​​of `phase`:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div><span class="code-block-extension-lang">javascript</span></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">export const PHASE_EXPORT = &#39;phase-export&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="2">export const PHASE_PRODUCTION_BUILD = &#39;phase-production-build&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="3">export const PHASE_PRODUCTION_SERVER = &#39;phase-production-server&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="4">export const PHASE_DEVELOPMENT_SERVER = &#39;phase-development-server&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="5">export const PHASE_TEST = &#39;phase-test&#39;</span>
</code></pre>

You can import it through `next/constants` to customize the configuration according to different stages:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div><span class="code-block-extension-lang">javascript</span></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">const { PHASE_DEVELOPMENT_SERVER } = require(&#39;next/constants&#39;)</span>
<span class="code-block-extension-codeLine" data-line-num="2"></span>
<span class="code-block-extension-codeLine" data-line-num="3">module.exports = (phase, { defaultConfig }) =&gt; {</span>
<span class="code-block-extension-codeLine" data-line-num="4">  if (phase === PHASE_DEVELOPMENT_SERVER) {</span>
<span class="code-block-extension-codeLine" data-line-num="5">    return {</span>
<span class="code-block-extension-codeLine" data-line-num="6">      /* Place development configuration options here*/</span>
<span class="code-block-extension-codeLine" data-line-num="7">    }</span>
<span class="code-block-extension-codeLine" data-line-num="8">  }</span>
<span class="code-block-extension-codeLine" data-line-num="9"></span>
<span class="code-block-extension-codeLine" data-line-num="10">  return {</span>
<span class="code-block-extension-codeLine" data-line-num="11">    /* Configuration of other stages except development stage*/</span>
<span class="code-block-extension-codeLine" data-line-num="12">  }</span>
<span class="code-block-extension-codeLine" data-line-num="13">}</span>
</code></pre>

In this example, the comment line is where you can put the configuration. In fact, Next.js defines a lot of configurations. You can check the [source code configuration file](https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fvercel%2Fnext.js%2Fblob%2Fcanary%2Fpackages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts "https://github.com/vercel/next.js/blob/canary/packages/next/src/server/config-shared.ts").

However, these configurations are not necessary, and there is no need to clearly understand the role of each configuration. Just take a general look and have an impression, and then check it in detail when you need it.

Because there are 36 configurations to be explained, the content is cumbersome and detailed, so the configuration part of `next.config.js` is divided into two parts. The previous article explains request-related headers, redirects, and rewrites. These are commonly used configurations in Next.js, and the contents have many similarities. Putting them together is convenient for analogy. The next article explains the remaining 33 configurations. Each configuration has a short content, so you only need to understand it.

Now let's start learning!

## 1. headers

### 1.1. Introduction

Headers are used to set custom HTTP headers, using the `headers` field of `next.config.js`:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div><span class="code-block-extension-lang">javascript</span></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">module.exports = {</span>
<span class="code-block-extension-codeLine" data-line-num="2">  async headers() {</span>
<span class="code-block-extension-codeLine" data-line-num="3">    return [</span>
<span class="code-block-extension-codeLine" data-line-num="4">      {</span>
<span class="code-block-extension-codeLine" data-line-num="5">        source: &#39;/about&#39;,</span>
<span class="code-block-extension-codeLine" data-line-num="6">        headers: [</span>
<span class="code-block-extension-codeLine" data-line-num="7">          {</span>
<span class="code-block-extension-codeLine" data-line-num="8">            key: &#39;x-custom-header&#39;,</span>
<span class="code-block-extension-codeLine" data-line-num="9">            value: &#39;my custom header value&#39;,</span>
<span class="code-block-extension-codeLine" data-line-num="10">          },</span>
<span class="code-block-extension-codeLine" data-line-num="11">          {</span>
<span class="code-block-extension-codeLine" data-line-num="12">            key: &#39;x-another-custom-header&#39;,</span>
<span class="code-block-extension-codeLine" data-line-num="13">            value: &#39;my other custom header value&#39;,</span>
<span class="code-block-extension-codeLine" data-line-num="14">          },</span>
<span class="code-block-extension-codeLine" data-line-num="15">        ],</span>
<span class="code-block-extension-codeLine" data-line-num="16">      },</span>
<span class="code-block-extension-codeLine" data-line-num="17">    ]</span>
<span class="code-block-extension-codeLine" data-line-num="18">  },</span>
<span class="code-block-extension-codeLine" data-line-num="19">}</span>
</code></pre>

Visit `/about` at this time, and you can see:

![Screenshot 2023-11-09 3.40.56 pm.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ca0818d69f76450182e9e9834080e0eb~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=2304&h=1528&s=400155&e=png&b=2a2a2a)

`headers` is an asynchronous function that returns an object array containing `source` and `headers` properties, where:

- `source` represents the incoming request path
- `headers` is a key and value Response header object array of the property

In addition to these two values, you can also set:

- `basePath`: `false` or `undefined`. When the value is `false`, `basePath` will not be included in the match, and can only be used for external rewrites
- `locale`: `false` or `undefined`, whether locale should be included in the match
- `has`: an object array with `type`, `key`, `value` properties
- `missing`: an object array with `type`, `key`, `value` properties

headers will be triggered before the file system (including pages and `/public` files).

Let's introduce these fields one by one with examples.

### 1.2. source

source represents the incoming request path. In addition to matching specific values, it also supports three matching modes:

#### Path matching

Normal path matching, for example, `/blog:slug` will match `/blog/hello-world` (no nested paths, that is, `/blog/hello-world/about` will not match)

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div><span class="code-block-extension-lang">javascript</span></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">// next.config.js</span>
<span class="code-block-extension-codeLine" data-line-num="2">module.exports = {</span>
<span class="code-block-extension-codeLine" data-line-num="3">  async headers() {</span>
<span class="code-block-extension-codeLine" data-line-num="4">    return [</span>
<span class="code-block-extension-codeLine" data-line-num="5">      {</span>
<span class="code-block-extension-codeLine" data-line-num="6">        source: &#39;/blog/:slug&#39;,</span>
<span class="code-block-extension-codeLine" data-line-num="7">        headers: [</span>
<span class="code-block-extension-codeLine" data-line-num="8">          {</span>
<span class="code-block-extension-codeLine" data-line-num="9">            key: &#39;x-slug&#39;,</span>
<span class="code-block-extension-codeLine" data-line-num="10">            value: &#39;:slug&#39;, // Matching parameters can be used in value</span>
<span class="code-block-extension-codeLine" data-line-num="11">          },</span>
<span class="code-block-extension-codeLine" data-line-num="12">          {</span>
<span class="code-block-extension-codeLine" data-line-num="13">            key: &#39;x-slug-:slug&#39;, // Matching parameters can be used in key</span>
<span class="code-block-extension-codeLine" data-line-num="14">            value: &#39;my other custom header value&#39;,</span>
<span class="code-block-extension-codeLine" data-line-num="15">          },</span>
<span class="code-block-extension-codeLine" data-line-num="16">        ],</span>
<span class="code-block-extension-codeLine" data-line-num="17">      },</span>
<span class="code-block-extension-codeLine" data-line-num="18">    ]</span>
<span class="code-block-extension-codeLine" data-line-num="19">  },</span>
<span class="code-block-extension-codeLine" data-line-num="20">}</span>
</code></pre>

Visit `/blog/hello-world`, you can see:

![Screenshot 2023-11-09 4.00.05.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f430b2c5e9a44a7d88dcaf32a3bdbad9~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=2294&h=1516&s=410172&e=png&b=2a2a2a)

But there will be no custom header when visiting `/blog/hello-world/about`.

#### Wildcard path matching

Use `*` after the parameter to achieve wildcard path matching. For example: `/blog/:slug*` will match `/blog/a/b/c/d/hello-world`:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div><span class="code-block-extension-lang">javascript</span></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">// next.config.js</span>
<span class="code-block-extension-codeLine" data-line-num="2">module.exports = {</span>
<span class="code-block-extension-codeLine" data-line-num="3">  async headers() {</span>
<span class="code-block-extension-codeLine" data-line-num="4">    return [</span>
<span class="code-block-extension-codeLine" data-line-num="5">      {</span>
<span class="code-block-extension-codeLine" data-line-num="6">        source: &#39;/blog/:slug*&#39;,</span>
<span class="code-block-extension-codeLine" data-line-num="7">        headers: [</span>
<span class="code-block-extension-codeLine" data-line-num="8">          {</span>
<span class="code-block-extension-codeLine" data-line-num="9">            key: &#39;x-slug&#39;,</span>
<span class="code-block-extension-codeLine" data-line-num="10">            value: &#39;:slug*&#39;,</span>
<span class="code-block-extension-codeLine" data-line-num="11">          },</span>
<span class="code-block-extension-codeLine" data-line-num="12">          {</span>
<span class="code-block-extension-codeLine" data-line-num="13">            key: &#39;x-slug-:slug*&#39;,</span>
<span class="code-block-extension-codeLine" data-line-num="14">            value: &#39;my other custom header value&#39;,</span>
<span class="code-block-extension-codeLine" data-line-num="15">          },</span>
<span class="code-block-extension-codeLine" data-line-num="16">        ],</span>
<span class="code-block-extension-codeLine" data-line-num="17">      },</span>
<span class="code-block-extension-codeLine" data-line-num="18">    ]</span>
<span class="code-block-extension-codeLine" data-line-num="19">  },</span>
<span class="code-block-extension-codeLine" data-line-num="20">}</span>
</code></pre>

Visit `/blog/hello-world/about`, you can see:

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/72fc974d27674c02a4e40057c49cc1ac~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=786&h=84&s=20629&e=png&b=282828)

Visit `/blog/hello-world` There are also:

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0c5756cc8262461a945a66436db9ee92~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=700&h=88&s=17996&e=png&b=282828)

#### Regular expression path matching

Regular expression matching is achieved by enclosing the regular expression in parentheses after the parameter. For example: `blog/:slug(\\d{1,})` matches `/blog/123` but not `/blog/abc`

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div><span class="code-block-extension-lang">javascript</span></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">// next.config.js</span>
<span class="code-block-extension-codeLine" data-line-num="2">module.exports = {</span>
<span class="code-block-extension-codeLine" data-line-num="3">  async headers() {</span>
<span class="code-block-extension-codeLine" data-line-num="4">    return [</span>
<span class="code-block-extension-codeLine" data-line-num="5">      {</span>
<span class="code-block-extension-codeLine" data-line-num="6">        source: &#39;/blog/:post(\\d{1,})&#39;,</span>
<span class="code-block-extension-codeLine" data-line-num="7">        headers: [</span>
<span class="code-block-extension-codeLine" data-line-num="8">          {</span>
<span class="code-block-extension-codeLine" data-line-num="9">            key: &#39;x-post&#39;,</span>
<span class="code-block-extension-codeLine" data-line-num="10">            value: &#39;:post&#39;,</span>
<span class="code-block-extension-codeLine" data-line-num="11">          },</span>
<span class="code-block-extension-codeLine" data-line-num="12">        ],</span>
<span class="code-block-extension-codeLine" data-line-num="13">      },</span>
<span class="code-block-extension-codeLine" data-line-num="14">    ]</span>
<span class="code-block-extension-codeLine" data-line-num="15">  },</span>
<span class="code-block-extension-codeLine" data-line-num="16">}</span>
</code></pre>

Visit `/blog/123`, and you can see:

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0738859e301945d9967e538636722a43~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=402&h=52&s=7281&e=png&b=282828)

Note: These 8 characters `(`, `)`, `{`, `}`, `:`, `*`, `+`, `?` are all used for regular expression matching, so when you need to use these characters themselves, use `\\` to escape them

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div><span class="code-block-extension-lang">javascript</span></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">// next.config.js</span>
<span class="code-block-extension-codeLine" data-line-num="2">module.exports = {</span>
<span class="code-block-extension-codeLine" data-line-num="3">  async headers() {</span>
<span class="code-block-extension-codeLine" data-line-num="4">    return [</span>
<span class="code-block-extension-codeLine" data-line-num="5">      {</span>
<span class="code-block-extension-codeLine" data-line-num="6">        // match`/english(default)/something`</span>
<span class="code-block-extension-codeLine" data-line-num="7">        source: &#39;/english\\(default\\)/:slug&#39;,</span>
<span class="code-block-extension-codeLine" data-line-num="8">        headers: [</span>
<span class="code-block-extension-codeLine" data-line-num="9">          {</span>
<span class="code-block-extension-codeLine" data-line-num="10">            key: &#39;x-header&#39;,</span>
<span class="code-block-extension-codeLine" data-line-num="11">            value: &#39;value&#39;,</span>
<span class="code-block-extension-codeLine" data-line-num="12">          },</span>
<span class="code-block-extension-codeLine" data-line-num="13">        ],</span>
<span class="code-block-extension-codeLine" data-line-num="14">      },</span>
<span class="code-block-extension-codeLine" data-line-num="15">    ]</span>
<span class="code-block-extension-codeLine" data-line-num="16">  },</span>
<span class="code-block-extension-codeLine" data-line-num="17">}</span></code></pre>
