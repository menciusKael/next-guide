## Preface

Middleware, a function that sounds very advanced and powerful. In fact, this is indeed the case. Using middleware, you can intercept and control all requests and responses in your application.

For example, you can rewrite, redirect, modify request or response headers, or even respond directly to the content based on the incoming request. A common application is authentication. Before opening the page to render specific content, it is first determined whether the user is logged in. If not, it jumps to the login page.

## definition

To write middleware, you need to define a file named `middleware.js` in the root directory of the project:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">// middleware.js</span>
<span class="code-block-extension-codeLine" data-line-num="2">import { NextResponse } from &#39;next/server&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="3"></span>
<span class="code-block-extension-codeLine" data-line-num="4">// </span>
<span class="code-block-extension-codeLine" data-line-num="5">export function middleware(request) {</span>
<span class="code-block-extension-codeLine" data-line-num="6">  return NextResponse.redirect(new URL(&#39;/home&#39;, request.url))</span>
<span class="code-block-extension-codeLine" data-line-num="7">}</span>
<span class="code-block-extension-codeLine" data-line-num="8"></span>
<span class="code-block-extension-codeLine" data-line-num="9">// </span>
<span class="code-block-extension-codeLine" data-line-num="10">export const config = {</span>
<span class="code-block-extension-codeLine" data-line-num="11">  matcher: &#39;/about/:path*&#39;,</span>
<span class="code-block-extension-codeLine" data-line-num="12">}</span>
</code></pre>

Note: The project root directory mentioned here refers to the same level as `pages` or `app`. But if the project uses the `src` directory, it will be placed under `src`.

In this example, we set the path for the middleware to take effect through `config.matcher`, and set the logic of the middleware in the `middleware` function. The function is to connect `/about`, `/about/xxx`, `/about/ Addresses such as xxx/xxx` are uniformly redirected to `/home`. The effect is as follows:

![middleware.gif](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fdca5873307f494b88c091513c81d072~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=720&h=154&s=25085&e=gif&f=17&b=ffffff)

## Set matching path

Now that we understand the general purpose, let’s look at the specific usage.

Let’s first talk about how to set the matching path. There are two ways to specify the path for middleware matching.

### matcher configuration items

The first is to use the `matcher` configuration item. The sample code is as follows:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">export const config = {</span>
<span class="code-block-extension-codeLine" data-line-num="2">  matcher: &#39;/about/:path*&#39;,</span>
<span class="code-block-extension-codeLine" data-line-num="3">}</span>
</code></pre>

`matcher` not only supports string form, but also array form, which is used to match multiple paths:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">export const config = {</span>
<span class="code-block-extension-codeLine" data-line-num="2">  matcher: [&#39;/about/:path*&#39;, &#39;/dashboard/:path*&#39;],</span>
<span class="code-block-extension-codeLine" data-line-num="3">}</span>
</code></pre>

Students who are new to it may feel strange about the usage of `:path*`. Its function is to convert path strings such as `/user/:name` into regular expressions. Next.js uses path-to-regexp to resolve addresses. As an open source library with a history of ten years, path-to-regexp is also referenced by many well-known libraries such as express, react-router, vue-router and so on. So let us know more about it.

path-to-regexp defines **named parameters** (Named Parameters) by adding a colon before the parameter name. The matcher supports named parameters, such as `/about/:path` matches `/about/a` and `/about/ b`, but does not match `/about/a/c`

Note: During actual testing, `/about/:path` cannot match `/about/xxx`, but can only match `/about`. If you want to match `/about/xxx`, you need to write `/about/:path` /`

The default matching logic of named parameters is `[^/]+`, but you can also add a bracket after the named parameter to customize the matching logic of named parameters, such as `/about/icon-:foo(\\d+ ).png` matches `/about/icon-1.png` but not `/about/icon-a.png`.

Named parameters can use modifiers, where `*` means 0 or 1 or more, `?` means 0 or 1, `+` means 1 or more, for example

- `/about/:path*` match `/about`、`/about/xxx`、`/about/xxx/xxx`
- `/about/:path?` match `/about`、`/about/xxx`
- `/about/:path+` match `/about/xxx`、`/about/xxx/xxx`

You can also use standard regular expressions in parentheses, such as `/about/(.*)` is equivalent to `/about/:path*`, such as `/(about|settings)` matches `/about` and ` /settings`, does not match other addresses. `/user-(ya|yu)` matches `/user-ya` and `/user-yu`.

A more complex and commonly used example is:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">export const config = {</span>
<span class="code-block-extension-codeLine" data-line-num="2">  matcher: [</span>
<span class="code-block-extension-codeLine" data-line-num="3">    /*</span>
<span class="code-block-extension-codeLine" data-line-num="4">     * </span>
<span class="code-block-extension-codeLine" data-line-num="5">     * - api (API routes)</span>
<span class="code-block-extension-codeLine" data-line-num="6">     * - _next/static (static files)</span>
<span class="code-block-extension-codeLine" data-line-num="7">     * - _next/image (image optimization files)</span>
<span class="code-block-extension-codeLine" data-line-num="8">     * - favicon.ico (favicon file)</span>
<span class="code-block-extension-codeLine" data-line-num="9">     */</span>
<span class="code-block-extension-codeLine" data-line-num="10">    &#39;/((?!api|_next/static|_next/image|favicon.ico).*)&#39;,</span>
<span class="code-block-extension-codeLine" data-line-num="11">  ],</span>
<span class="code-block-extension-codeLine" data-line-num="12">}</span>
</code></pre>

In addition, note that the path must start with `/`. The value of `matcher` must be a constant so that it can be statically analyzed at build time. Using dynamic values such as variables will be ignored.

The power of matcher goes far beyond regular expressions. Matcher can also determine query parameters, cookies, and headers:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">export const config = {</span>
<span class="code-block-extension-codeLine" data-line-num="2">  matcher: [</span>
<span class="code-block-extension-codeLine" data-line-num="3">    {</span>
<span class="code-block-extension-codeLine" data-line-num="4">      source: &#39;/api/*&#39;,</span>
<span class="code-block-extension-codeLine" data-line-num="5">      has: [</span>
<span class="code-block-extension-codeLine" data-line-num="6">        { type: &#39;header&#39;, key: &#39;Authorization&#39;, value: &#39;Bearer Token&#39; },</span>
<span class="code-block-extension-codeLine" data-line-num="7">        { type: &#39;query&#39;, key: &#39;userId&#39;, value: &#39;123&#39; },</span>
<span class="code-block-extension-codeLine" data-line-num="8">      ],</span>
<span class="code-block-extension-codeLine" data-line-num="9">      missing: [{ type: &#39;cookie&#39;, key: &#39;session&#39;, value: &#39;active&#39; }],</span>
<span class="code-block-extension-codeLine" data-line-num="10">    },</span>
<span class="code-block-extension-codeLine" data-line-num="11">  ],</span>
<span class="code-block-extension-codeLine" data-line-num="12">}</span>
</code></pre>

In this example, not only does the routing address match, but the Authorization of the header must be Bearer Token, the userId of the query parameter is 123, and the session value in the cookie is not active.

### Conditional statements

The second way is to use conditional statements:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">import { NextResponse } from &#39;next/server&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="2"></span>
<span class="code-block-extension-codeLine" data-line-num="3">export function middleware(request) {</span>
<span class="code-block-extension-codeLine" data-line-num="4">  if (request.nextUrl.pathname.startsWith(&#39;/about&#39;)) {</span>
<span class="code-block-extension-codeLine" data-line-num="5">    return NextResponse.rewrite(new URL(&#39;/about-2&#39;, request.url))</span>
<span class="code-block-extension-codeLine" data-line-num="6">  }</span>
<span class="code-block-extension-codeLine" data-line-num="7"></span>
<span class="code-block-extension-codeLine" data-line-num="8">  if (request.nextUrl.pathname.startsWith(&#39;/dashboard&#39;)) {</span>
<span class="code-block-extension-codeLine" data-line-num="9">    return NextResponse.rewrite(new URL(&#39;/dashboard/user&#39;, request.url))</span>
<span class="code-block-extension-codeLine" data-line-num="10">  }</span>
<span class="code-block-extension-codeLine" data-line-num="11">}</span>
</code></pre>

The matcher is very powerful, but sometimes it’s a headache if you don’t know how to write it, so just write it in specific logic!

##Middleware logic

Next, let's take a look at how to write middleware specifically:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">export function middleware(request) {</span>
<span class="code-block-extension-codeLine" data-line-num="2">  //  </span>
<span class="code-block-extension-codeLine" data-line-num="3">  //  </span>
<span class="code-block-extension-codeLine" data-line-num="4">  // </span>
<span class="code-block-extension-codeLine" data-line-num="5">}</span>
</code></pre>

###How to read and set cookies?

The usage is consistent with the routing handler, using NextRequest and NextResponse to quickly read and set cookies.

For incoming requests, NextRequest provides `get`, `getAll`, `set`, and `delete` methods to handle cookies. You can also use `has` to check cookies or `clear` to delete all cookies.

For the returned response, NextResponse also provides `get`, `getAll`, `set`, and `delete` methods to handle cookies. The example code is as follows:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">import { NextResponse } from &#39;next/server&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="2"></span>
<span class="code-block-extension-codeLine" data-line-num="3">export function middleware(request) {</span>
<span class="code-block-extension-codeLine" data-line-num="4">  //  &#34;Cookie:nextjs=fast&#34;</span>
<span class="code-block-extension-codeLine" data-line-num="5">  let cookie = request.cookies.get(&#39;nextjs&#39;)</span>
<span class="code-block-extension-codeLine" data-line-num="6">  console.log(cookie) // =&gt; { name: &#39;nextjs&#39;, value: &#39;fast&#39;, Path: &#39;/&#39; }</span>
<span class="code-block-extension-codeLine" data-line-num="7">  const allCookies = request.cookies.getAll()</span>
<span class="code-block-extension-codeLine" data-line-num="8">  console.log(allCookies) // =&gt; [{ name: &#39;nextjs&#39;, value: &#39;fast&#39; }]</span>
<span class="code-block-extension-codeLine" data-line-num="9"></span>
<span class="code-block-extension-codeLine" data-line-num="10">  request.cookies.has(&#39;nextjs&#39;) // =&gt; true</span>
<span class="code-block-extension-codeLine" data-line-num="11">  request.cookies.delete(&#39;nextjs&#39;)</span>
<span class="code-block-extension-codeLine" data-line-num="12">  request.cookies.has(&#39;nextjs&#39;) // =&gt; false</span>
<span class="code-block-extension-codeLine" data-line-num="13"></span>
<span class="code-block-extension-codeLine" data-line-num="14">  //  cookies</span>
<span class="code-block-extension-codeLine" data-line-num="15">  const response = NextResponse.next()</span>
<span class="code-block-extension-codeLine" data-line-num="16">  response.cookies.set(&#39;vercel&#39;, &#39;fast&#39;)</span>
<span class="code-block-extension-codeLine" data-line-num="17">  response.cookies.set({</span>
<span class="code-block-extension-codeLine" data-line-num="18">    name: &#39;vercel&#39;,</span>
<span class="code-block-extension-codeLine" data-line-num="19">    value: &#39;fast&#39;,</span>
<span class="code-block-extension-codeLine" data-line-num="20">    path: &#39;/&#39;,</span>
<span class="code-block-extension-codeLine" data-line-num="21">  })</span>
<span class="code-block-extension-codeLine" data-line-num="22">  cookie = response.cookies.get(&#39;vercel&#39;)</span>
<span class="code-block-extension-codeLine" data-line-num="23">  console.log(cookie) // =&gt; { name: &#39;vercel&#39;, value: &#39;fast&#39;, Path: &#39;/&#39; }</span>
<span class="code-block-extension-codeLine" data-line-num="24"></span>
<span class="code-block-extension-codeLine" data-line-num="25">  //   `Set-Cookie:vercel=fast;path=/test`</span>
<span class="code-block-extension-codeLine" data-line-num="26">  return response</span>
<span class="code-block-extension-codeLine" data-line-num="27">}</span>
</code></pre>

In this example, we called the 'NextResponse. next()' method, which is specifically used in middleware. After all, we are writing middleware, and after the middleware performs one layer of processing, the returned result needs to continue to be used in the next logic. At this point, we need to return 'NextResponse. next()'. Of course, if there is no need to move on to the next logic, you can directly return a Response instance, which will be demonstrated in the following example.

###How to read and set headers?

The usage is consistent with the routing handler, using NextRequest and NextResponse to quickly read and set headers. The example code is as follows:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">// middleware.js </span>
<span class="code-block-extension-codeLine" data-line-num="2">import { NextResponse } from &#39;next/server&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="3"></span>
<span class="code-block-extension-codeLine" data-line-num="4">export function middleware(request) {</span>
<span class="code-block-extension-codeLine" data-line-num="5">  //  clone </span>
<span class="code-block-extension-codeLine" data-line-num="6">  const requestHeaders = new Headers(request.headers)</span>
<span class="code-block-extension-codeLine" data-line-num="7">  requestHeaders.set(&#39;x-hello-from-middleware1&#39;, &#39;hello&#39;)</span>
<span class="code-block-extension-codeLine" data-line-num="8"></span>
<span class="code-block-extension-codeLine" data-line-num="9">  //  NextResponse.rewrite </span>
<span class="code-block-extension-codeLine" data-line-num="10">  const response = NextResponse.next({</span>
<span class="code-block-extension-codeLine" data-line-num="11">    request: {</span>
<span class="code-block-extension-codeLine" data-line-num="12">      // </span>
<span class="code-block-extension-codeLine" data-line-num="13">      headers: requestHeaders,</span>
<span class="code-block-extension-codeLine" data-line-num="14">    },</span>
<span class="code-block-extension-codeLine" data-line-num="15">  })</span>
<span class="code-block-extension-codeLine" data-line-num="16"></span>
<span class="code-block-extension-codeLine" data-line-num="17">  //  `x-hello-from-middleware2`</span>
<span class="code-block-extension-codeLine" data-line-num="18">  response.headers.set(&#39;x-hello-from-middleware2&#39;, &#39;hello&#39;)</span>
<span class="code-block-extension-codeLine" data-line-num="19">  return response</span>
<span class="code-block-extension-codeLine" data-line-num="20">}</span>
</code></pre>

The special aspect of this example is that when calling NextResponse. next, an object is passed in to forward headers, according to [NextResponse]（ https://link.juejin.cn/?target=https%3A%2F%2Fnextjs.org%2Fdocs%2Fapp%2Fapi -Reference% 2Ffunctions% 2Fnext response“ https://nextjs.org/docs/app/api-reference/functions/next-response The official document of () currently only uses this usage.

####CORS

This is an example of setting CORS that will be used in actual development:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">import { NextResponse } from &#39;next/server&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="2"></span>
<span class="code-block-extension-codeLine" data-line-num="3">const allowedOrigins = [&#39;https://acme.com&#39;, &#39;https://my-app.org&#39;]</span>
<span class="code-block-extension-codeLine" data-line-num="4"></span>
<span class="code-block-extension-codeLine" data-line-num="5">const corsOptions = {</span>
<span class="code-block-extension-codeLine" data-line-num="6">  &#39;Access-Control-Allow-Methods&#39;: &#39;GET, POST, PUT, DELETE, OPTIONS&#39;,</span>
<span class="code-block-extension-codeLine" data-line-num="7">  &#39;Access-Control-Allow-Headers&#39;: &#39;Content-Type, Authorization&#39;,</span>
<span class="code-block-extension-codeLine" data-line-num="8">}</span>
<span class="code-block-extension-codeLine" data-line-num="9"></span>
<span class="code-block-extension-codeLine" data-line-num="10">export function middleware(request) {</span>
<span class="code-block-extension-codeLine" data-line-num="11">  // Check the origin from the request</span>
<span class="code-block-extension-codeLine" data-line-num="12">  const origin = request.headers.get(&#39;origin&#39;) ?? &#39;&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="13">  const isAllowedOrigin = allowedOrigins.includes(origin)</span>
<span class="code-block-extension-codeLine" data-line-num="14"></span>
<span class="code-block-extension-codeLine" data-line-num="15">  // Handle preflighted requests</span>
<span class="code-block-extension-codeLine" data-line-num="16">  const isPreflight = request.method === &#39;OPTIONS&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="17"></span>
<span class="code-block-extension-codeLine" data-line-num="18">  if (isPreflight) {</span>
<span class="code-block-extension-codeLine" data-line-num="19">    const preflightHeaders = {</span>
<span class="code-block-extension-codeLine" data-line-num="20">      ...(isAllowedOrigin &amp;&amp; { &#39;Access-Control-Allow-Origin&#39;: origin }),</span>
<span class="code-block-extension-codeLine" data-line-num="21">      ...corsOptions,</span>
<span class="code-block-extension-codeLine" data-line-num="22">    }</span>
<span class="code-block-extension-codeLine" data-line-num="23">    return NextResponse.json({}, { headers: preflightHeaders })</span>
<span class="code-block-extension-codeLine" data-line-num="24">  }</span>
<span class="code-block-extension-codeLine" data-line-num="25"></span>
<span class="code-block-extension-codeLine" data-line-num="26">  // Handle simple requests</span>
<span class="code-block-extension-codeLine" data-line-num="27">  const response = NextResponse.next()</span>
<span class="code-block-extension-codeLine" data-line-num="28"></span>
<span class="code-block-extension-codeLine" data-line-num="29">  if (isAllowedOrigin) {</span>
<span class="code-block-extension-codeLine" data-line-num="30">    response.headers.set(&#39;Access-Control-Allow-Origin&#39;, origin)</span>
<span class="code-block-extension-codeLine" data-line-num="31">  }</span>
<span class="code-block-extension-codeLine" data-line-num="32"></span>
<span class="code-block-extension-codeLine" data-line-num="33">  Object.entries(corsOptions).forEach(([key, value]) =&gt; {</span>
<span class="code-block-extension-codeLine" data-line-num="34">    response.headers.set(key, value)</span>
<span class="code-block-extension-codeLine" data-line-num="35">  })</span>
<span class="code-block-extension-codeLine" data-line-num="36"></span>
<span class="code-block-extension-codeLine" data-line-num="37">  return response</span>
<span class="code-block-extension-codeLine" data-line-num="38">}</span>
<span class="code-block-extension-codeLine" data-line-num="39"></span>
<span class="code-block-extension-codeLine" data-line-num="40">export const config = {</span>
<span class="code-block-extension-codeLine" data-line-num="41">  matcher: &#39;/api/:path*&#39;,</span>
<span class="code-block-extension-codeLine" data-line-num="42">}</span>
</code></pre>

###How to respond directly?

The usage is consistent with the routing handler, using NextResponse to set the returned Response. The example code is as follows:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">import { NextResponse } from &#39;next/server&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="2">import { isAuthenticated } from &#39;@lib/auth&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="3"></span>
<span class="code-block-extension-codeLine" data-line-num="4">export const config = {</span>
<span class="code-block-extension-codeLine" data-line-num="5">  matcher: &#39;/api/:function*&#39;,</span>
<span class="code-block-extension-codeLine" data-line-num="6">}</span>
<span class="code-block-extension-codeLine" data-line-num="7"></span>
<span class="code-block-extension-codeLine" data-line-num="8">export function middleware(request) {</span>
<span class="code-block-extension-codeLine" data-line-num="9">  // </span>
<span class="code-block-extension-codeLine" data-line-num="10">  if (!isAuthenticated(request)) {</span>
<span class="code-block-extension-codeLine" data-line-num="11">    // </span>
<span class="code-block-extension-codeLine" data-line-num="12">    return new NextResponse(</span>
<span class="code-block-extension-codeLine" data-line-num="13">      JSON.stringify({ success: false, message: &#39;authentication failed&#39; }),</span>
<span class="code-block-extension-codeLine" data-line-num="14">      { status: 401, headers: { &#39;content-type&#39;: &#39;application/json&#39; } }</span>
<span class="code-block-extension-codeLine" data-line-num="15">    )</span>
<span class="code-block-extension-codeLine" data-line-num="16">  }</span>
<span class="code-block-extension-codeLine" data-line-num="17">}</span></code></pre>

## Execution order

In Next.js, there are many places where you can set the route response. For example, it can be set in next.config.js, it can be set in middleware, and it can be set in specific routes, so you should pay attention to their execution order:

1. `headers` (`next.config.js`)
2. `redirects` (`next.config.js`)
3. Middleware (`rewrites`, `redirects`, etc.)
4. `beforeFiles` (`rewrites` in `next.config.js`)
5. Routing based on file system (`public/`, `_next/static/`, `pages/`, `app/`, etc.)
6. `afterFiles` (`rewrites` in `next.config.js`)
7. Dynamic routing (`/blog/[slug]`)
8. `fallback` (`rewrites` in `next.config.js`)

Note: `beforeFiles`, as the name suggests, is before file system-based routing, `afterFiles`, as its name suggests, is after file system-based routing, and `fallback`, as its name suggests, is executed at the bottom.

What exactly does the execution sequence do? In fact, we can find out by writing a demo and testing it. The file directory is as follows:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-markdown code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">next-app             </span>
<span class="code-block-extension-codeLine" data-line-num="2">├─ app                      </span>
<span class="code-block-extension-codeLine" data-line-num="3">│  ├─ blog                  </span>
<span class="code-block-extension-codeLine" data-line-num="4">│  │  ├─ [id]               </span>
<span class="code-block-extension-codeLine" data-line-num="5">│  │  │  └─ page.js         </span>
<span class="code-block-extension-codeLine" data-line-num="6">│  │  ├─ yayu               </span>
<span class="code-block-extension-codeLine" data-line-num="7">│  │  │  └─ page.js         </span>
<span class="code-block-extension-codeLine" data-line-num="8">│  │  └─ page.js                                    </span>
<span class="code-block-extension-codeLine" data-line-num="9">├─ middleware.js            </span>
<span class="code-block-extension-codeLine" data-line-num="10">└─ next.config.js</span>
</code></pre>

`redirects`, `rewrites` are declared in `next.config.js`:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">module.exports = {</span>
<span class="code-block-extension-codeLine" data-line-num="2">  async redirects() {</span>
<span class="code-block-extension-codeLine" data-line-num="3">    return [</span>
<span class="code-block-extension-codeLine" data-line-num="4">      {</span>
<span class="code-block-extension-codeLine" data-line-num="5">        source: &#39;/blog/yayu&#39;,</span>
<span class="code-block-extension-codeLine" data-line-num="6">        destination: &#39;/blog/yayu_redirects&#39;,</span>
<span class="code-block-extension-codeLine" data-line-num="7">        permanent: true,</span>
<span class="code-block-extension-codeLine" data-line-num="8">      },</span>
<span class="code-block-extension-codeLine" data-line-num="9">    ]</span>
<span class="code-block-extension-codeLine" data-line-num="10">  },</span>
<span class="code-block-extension-codeLine" data-line-num="11">  async rewrites() {</span>
<span class="code-block-extension-codeLine" data-line-num="12">    return {</span>
<span class="code-block-extension-codeLine" data-line-num="13">      beforeFiles: [</span>
<span class="code-block-extension-codeLine" data-line-num="14">        {</span>
<span class="code-block-extension-codeLine" data-line-num="15">          source: &#39;/blog/yayu&#39;,</span>
<span class="code-block-extension-codeLine" data-line-num="16">          destination: &#39;/blog/yayu_beforeFiles&#39;,</span>
<span class="code-block-extension-codeLine" data-line-num="17">        },</span>
<span class="code-block-extension-codeLine" data-line-num="18">      ],</span>
<span class="code-block-extension-codeLine" data-line-num="19">      afterFiles: [</span>
<span class="code-block-extension-codeLine" data-line-num="20">        {</span>
<span class="code-block-extension-codeLine" data-line-num="21">          source: &#39;/blog/yayu&#39;,</span>
<span class="code-block-extension-codeLine" data-line-num="22">          destination: &#39;/blog/yayu_afterFiles&#39;,</span>
<span class="code-block-extension-codeLine" data-line-num="23">        },</span>
<span class="code-block-extension-codeLine" data-line-num="24">      ],</span>
<span class="code-block-extension-codeLine" data-line-num="25">      fallback: [</span>
<span class="code-block-extension-codeLine" data-line-num="26">        {</span>
<span class="code-block-extension-codeLine" data-line-num="27">          source: &#39;/blog/yayu&#39;,</span>
<span class="code-block-extension-codeLine" data-line-num="28">          destination: `/blog/yayu_fallback`,</span>
<span class="code-block-extension-codeLine" data-line-num="29">        },</span>
<span class="code-block-extension-codeLine" data-line-num="30">      ],</span>
<span class="code-block-extension-codeLine" data-line-num="31">    }</span>
<span class="code-block-extension-codeLine" data-line-num="32">  },</span>
<span class="code-block-extension-codeLine" data-line-num="33">}</span>
</code></pre>

The code of `middleware.js` is as follows:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">import { NextResponse } from &#39;next/server&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="2"></span>
<span class="code-block-extension-codeLine" data-line-num="3">export function middleware(request) {</span>
<span class="code-block-extension-codeLine" data-line-num="4">  return NextResponse.redirect(new URL(&#39;/blog/yayu_middleware&#39;, request.url))</span>
<span class="code-block-extension-codeLine" data-line-num="5">}</span>
<span class="code-block-extension-codeLine" data-line-num="6"></span>
<span class="code-block-extension-codeLine" data-line-num="7">export const config = {</span>
<span class="code-block-extension-codeLine" data-line-num="8">  matcher: &#39;/blog/yayu&#39;,</span>
<span class="code-block-extension-codeLine" data-line-num="9">}</span>
</code></pre>

The code of `app/blog/page.js` is as follows:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">import { redirect } from &#39;next/navigation&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="2"></span>
<span class="code-block-extension-codeLine" data-line-num="3">export default function Page() {</span>
<span class="code-block-extension-codeLine" data-line-num="4">  redirect(&#39;/blog/yayu_page&#39;)</span>
<span class="code-block-extension-codeLine" data-line-num="5">}</span>
</code></pre>

The code of `app/blog/[id]/page.js` is as follows:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">import { redirect } from &#39;next/navigation&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="2"></span>
<span class="code-block-extension-codeLine" data-line-num="3">export default function Page() {</span>
<span class="code-block-extension-codeLine" data-line-num="4">  redirect(&#39;/blog/yayu_slug&#39;)</span>
<span class="code-block-extension-codeLine" data-line-num="5">}</span>
</code></pre>

Now that we have configured redirection and rewriting in multiple places, the question is, now when we visit `/blog/yayu`, what is the URL that is finally displayed in the browser address bar?

The answer is `/blog/yayu_slug`. According to the execution order, access `/blog/yayu`, first redirect to `/blog/yayu_redirects` according to `redirects` of `next.config.js`, then go to the logic of dynamic routing and redirect to `/blog/ yayu_slug`.

## Middleware related configuration items

Next.js v13.1 adds two new configuration items to middleware, `skipMiddlewareUrlNormalize` and `skipTrailingSlashRedirect`, to handle some special situations.

### skipTrailingSlashRedirect

First, let’s explain **Trailing Slashes**, which is translated in Chinese as “tail slash”. It refers to the forward slash placed at the end of the URL. For example: `www.yauyjs.com/users/`The last one in the address A slash is a trailing slash.

Generally speaking, the trailing slash is used to distinguish a directory or a file. If there is a trailing slash, it indicates a directory. If there is no trailing slash, it indicates a file. Of course, this is just a suggestion, you can handle it however you want.

From a URL perspective, `www.yauyjs.com/users/` and `www.yayujs.com/users` are two addresses, but usually we will redirect them. For example, if you access `/about/` in Next.js, it will automatically redirect to `/about`, and the URL will also change to `/about`.

**skipTrailingSlashRedirect** As the name suggests, skip the trailing slash redirect. When you set `skipTrailingSlashRedirect` to true, if you visit `/about/` again, the URL will still be `/about/`.

The sample code using `skipTrailingSlashRedirect` is as follows:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">// next.config.js</span>
<span class="code-block-extension-codeLine" data-line-num="2">module.exports = {</span>
<span class="code-block-extension-codeLine" data-line-num="3">  skipTrailingSlashRedirect: true,</span>
<span class="code-block-extension-codeLine" data-line-num="4">}</span>
</code></pre>

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">// middleware.js</span>
<span class="code-block-extension-codeLine" data-line-num="2">const legacyPrefixes = [&#39;/docs&#39;, &#39;/blog&#39;]</span>
<span class="code-block-extension-codeLine" data-line-num="3"></span>
<span class="code-block-extension-codeLine" data-line-num="4">export default async function middleware(req) {</span>
<span class="code-block-extension-codeLine" data-line-num="5">  const { pathname } = req.nextUrl</span>
<span class="code-block-extension-codeLine" data-line-num="6"></span>
<span class="code-block-extension-codeLine" data-line-num="7">  if (legacyPrefixes.some((prefix) =&gt; pathname.startsWith(prefix))) {</span>
<span class="code-block-extension-codeLine" data-line-num="8">    return NextResponse.next()</span>
<span class="code-block-extension-codeLine" data-line-num="9">  }</span>
<span class="code-block-extension-codeLine" data-line-num="10"></span>
<span class="code-block-extension-codeLine" data-line-num="11">  // </span>
<span class="code-block-extension-codeLine" data-line-num="12">  if (</span>
<span class="code-block-extension-codeLine" data-line-num="13">    !pathname.endsWith(&#39;/&#39;) &amp;&amp;</span>
<span class="code-block-extension-codeLine" data-line-num="14">    !pathname.match(/((?!\.well-known(?:\/.*)?)(?:[^/]+\/)*[^/]+\.\w+)/)</span>
<span class="code-block-extension-codeLine" data-line-num="15">  ) {</span>
<span class="code-block-extension-codeLine" data-line-num="16">    req.nextUrl.pathname += &#39;/&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="17">    return NextResponse.redirect(req.nextUrl)</span>
<span class="code-block-extension-codeLine" data-line-num="18">  }</span>
<span class="code-block-extension-codeLine" data-line-num="19">}</span>
</code></pre>

In this example, here we implement that except for the routes with `/docs` and `/blog` as prefixes, other routes automatically add trailing slashes.

### skipMiddlewareUrlNormalize

Regarding **skipMiddlewareUrlNormalize** , let’s look directly at an example:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">// next.config.js</span>
<span class="code-block-extension-codeLine" data-line-num="2">module.exports = {</span>
<span class="code-block-extension-codeLine" data-line-num="3">  skipMiddlewareUrlNormalize: true,</span>
<span class="code-block-extension-codeLine" data-line-num="4">}</span>
</code></pre>

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">// middleware.js</span>
<span class="code-block-extension-codeLine" data-line-num="2">export default async function middleware(req) {</span>
<span class="code-block-extension-codeLine" data-line-num="3">  const { pathname } = req.nextUrl</span>
<span class="code-block-extension-codeLine" data-line-num="4"></span>
<span class="code-block-extension-codeLine" data-line-num="5">  // GET /_next/data/build-id/hello.json</span>
<span class="code-block-extension-codeLine" data-line-num="6"></span>
<span class="code-block-extension-codeLine" data-line-num="7">  console.log(pathname)</span>
<span class="code-block-extension-codeLine" data-line-num="8">  //  /_next/data/build-id/hello.json</span>
<span class="code-block-extension-codeLine" data-line-num="9">  //   /hello</span>
<span class="code-block-extension-codeLine" data-line-num="10">}</span>
</code></pre>

After setting **skipMiddlewareUrlNormalize** to true, you can obtain the original address of the route, which is often used in international scenarios.

## Runtime

When using Middleware, it is also important to note that currently Middleware only supports Edge runtime and does not support Node.js runtime. This means that when writing Middleware, try to use web APIs as much as possible and avoid using Node.js APIs

### Practical operation: Control the number of requests

Requirement: If you have called the OpenAI interface, the commonly used ChatGPT v3.5 interface will have a maximum limit of 3 calls per minute. Now you have also developed an interface for '/API/chat', which limits calls to a maximum of 3 times per minute to prevent malicious calls. How to implement using Next.js?

Let's make it happen! For this, we need to install a dependency package [limiter](https://link.juejin.cn/?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Flimiter "https://www.npmjs.com/package/limiter")：

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-bash code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">npm install limiter</span>
</code></pre>

Create a new 'app/app/chat/route. js' with the following code:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1"></span>
<span class="code-block-extension-codeLine" data-line-num="2">import { NextResponse } from &#39;next/server&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="3">import { RateLimiter } from &#34;limiter&#34;;</span>
<span class="code-block-extension-codeLine" data-line-num="4">const limiter = new RateLimiter({ tokensPerInterval: 3, interval: &#34;min&#34;, fireImmediately: true });</span>
<span class="code-block-extension-codeLine" data-line-num="5"></span>
<span class="code-block-extension-codeLine" data-line-num="6">export async function GET() {</span>
<span class="code-block-extension-codeLine" data-line-num="7">  const remainingRequests = await limiter.removeTokens(1);</span>
<span class="code-block-extension-codeLine" data-line-num="8">  if (remainingRequests &lt; 0) {</span>
<span class="code-block-extension-codeLine" data-line-num="9">    return new NextResponse(</span>
<span class="code-block-extension-codeLine" data-line-num="10">      JSON.stringify({ success: false, message: &#39;Too Many Requests&#39; }),</span>
<span class="code-block-extension-codeLine" data-line-num="11">      { status: 429, headers: { &#39;content-type&#39;: &#39;application/json&#39; } }</span>
<span class="code-block-extension-codeLine" data-line-num="12">    )</span>
<span class="code-block-extension-codeLine" data-line-num="13">  }</span>
<span class="code-block-extension-codeLine" data-line-num="14"></span>
<span class="code-block-extension-codeLine" data-line-num="15">  return NextResponse.json({ data: &#34;你好！&#34; })</span>
<span class="code-block-extension-codeLine" data-line-num="16">}</span>
</code></pre>

At this point, it runs successfully with the following effect:

![middleware-1.gif](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5309c82eccdf4c1b8223399f12348442~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=720&h=154&s=20799&e=gif&f=20&b=fdfdfd)

We have written the logic of controlling the number of times in the specific routing, now let's try to write it in the middleware:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">import { NextResponse } from &#39;next/server&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="2">import { RateLimiter } from &#34;limiter&#34;;</span>
<span class="code-block-extension-codeLine" data-line-num="3">const limiter = new RateLimiter({ tokensPerInterval: 3, interval: &#34;min&#34;, fireImmediately: true });</span>
<span class="code-block-extension-codeLine" data-line-num="4"></span>
<span class="code-block-extension-codeLine" data-line-num="5">export async function middleware(request) {</span>
<span class="code-block-extension-codeLine" data-line-num="6"></span>
<span class="code-block-extension-codeLine" data-line-num="7">  const remainingRequests = await limiter.removeTokens(1);</span>
<span class="code-block-extension-codeLine" data-line-num="8">  if (remainingRequests &lt; 0) {</span>
<span class="code-block-extension-codeLine" data-line-num="9">    return new NextResponse(</span>
<span class="code-block-extension-codeLine" data-line-num="10">      JSON.stringify({ success: false, message: &#39;Too Many Requests&#39; }),</span>
<span class="code-block-extension-codeLine" data-line-num="11">      { status: 429, headers: { &#39;content-type&#39;: &#39;application/json&#39; } }</span>
<span class="code-block-extension-codeLine" data-line-num="12">    )</span>
<span class="code-block-extension-codeLine" data-line-num="13">  }</span>
<span class="code-block-extension-codeLine" data-line-num="14"></span>
<span class="code-block-extension-codeLine" data-line-num="15">  return NextResponse.next()</span>
<span class="code-block-extension-codeLine" data-line-num="16">}</span>
<span class="code-block-extension-codeLine" data-line-num="17"></span>
<span class="code-block-extension-codeLine" data-line-num="18">// </span>
<span class="code-block-extension-codeLine" data-line-num="19">export const config = {</span>
<span class="code-block-extension-codeLine" data-line-num="20">  matcher: &#39;/api/chat&#39;,</span>
<span class="code-block-extension-codeLine" data-line-num="21">}</span>
</code></pre>

However, at this point you will find:

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/373759a3b9bf4ac8b4aeeb0f266bd62e~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=2202&h=1062&s=258688&e=png&b=eaeaea)

Why is the code reporting an error?

This is a common mistake that beginners make when writing middleware. The reason for the error is that the limiter is actually a library used in the node.js environment. However, currently Middleware only supports Edge runtime and does not support Node.js runtime, which is why an error is reported. Taking this project as an example is just to remind everyone to pay attention to runtime issues.

##Code maintenance of middleware

If the project is relatively simple, middleware code is usually not written in large quantities, so writing all the code together is not a big problem. But when the project becomes complex, such as having to authenticate, control requests, internationalize, and so on in the middleware, all kinds of logic are written together, and the middleware quickly becomes difficult to maintain. If we want to implement multiple requirements in middleware, how can we reasonably split the code?

A simple way is:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">import { NextResponse } from &#39;next/server&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="2"></span>
<span class="code-block-extension-codeLine" data-line-num="3">async function middleware1(request) {</span>
<span class="code-block-extension-codeLine" data-line-num="4">  console.log(request.url)</span>
<span class="code-block-extension-codeLine" data-line-num="5">  return NextResponse.next()</span>
<span class="code-block-extension-codeLine" data-line-num="6">}</span>
<span class="code-block-extension-codeLine" data-line-num="7"></span>
<span class="code-block-extension-codeLine" data-line-num="8">async function middleware2(request) {</span>
<span class="code-block-extension-codeLine" data-line-num="9">  console.log(request.url)</span>
<span class="code-block-extension-codeLine" data-line-num="10">  return NextResponse.next()</span>
<span class="code-block-extension-codeLine" data-line-num="11">}</span>
<span class="code-block-extension-codeLine" data-line-num="12"></span>
<span class="code-block-extension-codeLine" data-line-num="13">export async function middleware(request) {</span>
<span class="code-block-extension-codeLine" data-line-num="14">  await middleware1(request)</span>
<span class="code-block-extension-codeLine" data-line-num="15">  await middleware2(request)</span>
<span class="code-block-extension-codeLine" data-line-num="16">}</span>
<span class="code-block-extension-codeLine" data-line-num="17"></span>
<span class="code-block-extension-codeLine" data-line-num="18">export const config = {</span>
<span class="code-block-extension-codeLine" data-line-num="19">  matcher: &#39;/api/:path*&#39;,</span>
<span class="code-block-extension-codeLine" data-line-num="20">}</span>
</code></pre>

A more elegant way is to use high-order functions:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">import { NextResponse } from &#39;next/server&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="2"></span>
<span class="code-block-extension-codeLine" data-line-num="3">function withMiddleware1(middleware) {</span>
<span class="code-block-extension-codeLine" data-line-num="4">  return async (request) =&gt; {</span>
<span class="code-block-extension-codeLine" data-line-num="5">    console.log(&#39;middleware1 &#39; + request.url)</span>
<span class="code-block-extension-codeLine" data-line-num="6">    return middleware(request)</span>
<span class="code-block-extension-codeLine" data-line-num="7">  }</span>
<span class="code-block-extension-codeLine" data-line-num="8">}</span>
<span class="code-block-extension-codeLine" data-line-num="9"></span>
<span class="code-block-extension-codeLine" data-line-num="10">function withMiddleware2(middleware) {</span>
<span class="code-block-extension-codeLine" data-line-num="11">  return async (request) =&gt; {</span>
<span class="code-block-extension-codeLine" data-line-num="12">    console.log(&#39;middleware2 &#39; + request.url)</span>
<span class="code-block-extension-codeLine" data-line-num="13">    return middleware(request)</span>
<span class="code-block-extension-codeLine" data-line-num="14">  }</span>
<span class="code-block-extension-codeLine" data-line-num="15">}</span>
<span class="code-block-extension-codeLine" data-line-num="16"></span>
<span class="code-block-extension-codeLine" data-line-num="17">async function middleware(request) {</span>
<span class="code-block-extension-codeLine" data-line-num="18">  console.log(&#39;middleware &#39; + request.url)</span>
<span class="code-block-extension-codeLine" data-line-num="19">  return NextResponse.next()</span>
<span class="code-block-extension-codeLine" data-line-num="20">}</span>
<span class="code-block-extension-codeLine" data-line-num="21"></span>
<span class="code-block-extension-codeLine" data-line-num="22">export default withMiddleware2(withMiddleware1(middleware))</span>
<span class="code-block-extension-codeLine" data-line-num="23"></span>
<span class="code-block-extension-codeLine" data-line-num="24">export const config = {</span>
<span class="code-block-extension-codeLine" data-line-num="25">  matcher: &#39;/api/:path*&#39;,</span>
<span class="code-block-extension-codeLine" data-line-num="26">}</span>
</code></pre>

May I ask what is the execution order at this time? Try printing it out. Do you feel like you're back to learning Redux?

But it's still a bit cumbersome to write like this, let's write a utility function to help us:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">import { NextResponse } from &#39;next/server&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="2"></span>
<span class="code-block-extension-codeLine" data-line-num="3">function chain(functions, index = 0) {</span>
<span class="code-block-extension-codeLine" data-line-num="4">  const current = functions[index];</span>
<span class="code-block-extension-codeLine" data-line-num="5">  if (current) {</span>
<span class="code-block-extension-codeLine" data-line-num="6">    const next = chain(functions, index + 1);</span>
<span class="code-block-extension-codeLine" data-line-num="7">    return current(next);</span>
<span class="code-block-extension-codeLine" data-line-num="8">  }</span>
<span class="code-block-extension-codeLine" data-line-num="9">  return () =&gt; NextResponse.next();</span>
<span class="code-block-extension-codeLine" data-line-num="10">}</span>
<span class="code-block-extension-codeLine" data-line-num="11"></span>
<span class="code-block-extension-codeLine" data-line-num="12">function withMiddleware1(middleware) {</span>
<span class="code-block-extension-codeLine" data-line-num="13">  return async (request) =&gt; {</span>
<span class="code-block-extension-codeLine" data-line-num="14">    console.log(&#39;middleware1 &#39; + request.url)</span>
<span class="code-block-extension-codeLine" data-line-num="15">    return middleware(request)</span>
<span class="code-block-extension-codeLine" data-line-num="16">  }</span>
<span class="code-block-extension-codeLine" data-line-num="17">}</span>
<span class="code-block-extension-codeLine" data-line-num="18"></span>
<span class="code-block-extension-codeLine" data-line-num="19">function withMiddleware2(middleware) {</span>
<span class="code-block-extension-codeLine" data-line-num="20">  return async (request) =&gt; {</span>
<span class="code-block-extension-codeLine" data-line-num="21">    console.log(&#39;middleware2 &#39; + request.url)</span>
<span class="code-block-extension-codeLine" data-line-num="22">    return middleware(request)</span>
<span class="code-block-extension-codeLine" data-line-num="23">  }</span>
<span class="code-block-extension-codeLine" data-line-num="24">}</span>
<span class="code-block-extension-codeLine" data-line-num="25"></span>
<span class="code-block-extension-codeLine" data-line-num="26">export default chain([withMiddleware1, withMiddleware2])</span>
<span class="code-block-extension-codeLine" data-line-num="27"></span>
<span class="code-block-extension-codeLine" data-line-num="28">export const config = {</span>
<span class="code-block-extension-codeLine" data-line-num="29">  matcher: &#39;/api/:path*&#39;,</span>
<span class="code-block-extension-codeLine" data-line-num="30">}</span>
</code></pre>

May I ask what is the execution order at this time? The answer is in the order of the array, middleware1, middleware2.

If this approach is used, during actual development, the code will look like:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">import { chain } from &#34;@/lib/utils&#34;;</span>
<span class="code-block-extension-codeLine" data-line-num="2">import { withHeaders } from &#34;@/middlewares/withHeaders&#34;;</span>
<span class="code-block-extension-codeLine" data-line-num="3">import { withLogging } from &#34;@/middlewares/withLogging&#34;;</span>
<span class="code-block-extension-codeLine" data-line-num="4"></span>
<span class="code-block-extension-codeLine" data-line-num="5">export default chain([withLogging, withHeaders]);</span>
<span class="code-block-extension-codeLine" data-line-num="6"></span>
<span class="code-block-extension-codeLine" data-line-num="7">export const config = {</span>
<span class="code-block-extension-codeLine" data-line-num="8">  matcher: &#39;/api/:path*&#39;,</span>
<span class="code-block-extension-codeLine" data-line-num="9">}</span>
</code></pre>

When writing middleware specifically:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">export const withHeaders = (next) =&gt; {</span>
<span class="code-block-extension-codeLine" data-line-num="2">  return async (request) =&gt; {</span>
<span class="code-block-extension-codeLine" data-line-num="3">    // ...</span>
<span class="code-block-extension-codeLine" data-line-num="4">    return next(request);</span>
<span class="code-block-extension-codeLine" data-line-num="5">  };</span>
<span class="code-block-extension-codeLine" data-line-num="6">};</span></code></pre>
