## Preface

Middleware, a function that sounds very advanced and powerful. In fact, this is indeed the case. Using middleware, you can intercept and control all requests and responses in your application.

For example, you can rewrite, redirect, modify request or response headers, or even respond directly to the content based on the incoming request. A common application is authentication. Before opening the page to render specific content, it is first determined whether the user is logged in. If not, it jumps to the login page.

## definition

To write middleware, you need to define a file named `middleware.js` in the root directory of the project:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">// middleware.js</span>
<span class="code-block-extension-codeLine" data-line-num="2">import { NextResponse } from &#39;next/server&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="3"></span>
<span class="code-block-extension-codeLine" data-line-num="4">// </span>
<span class="code-block-extension-codeLine" data-line-num="5">export function middleware(request) {</span>
<span class="code-block-extension-codeLine" data-line-num="6">  return NextResponse.redirect(new URL(&#39;/home&#39;, request.url))</span>
<span class="code-block-extension-codeLine" data-line-num="7">}</span>
<span class="code-block-extension-codeLine" data-line-num="8"></span>
<span class="code-block-extension-codeLine" data-line-num="9">// </span>
<span class="code-block-extension-codeLine" data-line-num="10">export const config = {</span>
<span class="code-block-extension-codeLine" data-line-num="11">  matcher: &#39;/about/:path*&#39;,</span>
<span class="code-block-extension-codeLine" data-line-num="12">}</span>
</code></pre>

Note: The project root directory mentioned here refers to the same level as `pages` or `app`. But if the project uses the `src` directory, it will be placed under `src`.

In this example, we set the path for the middleware to take effect through `config.matcher`, and set the logic of the middleware in the `middleware` function. The function is to connect `/about`, `/about/xxx`, `/about/ Addresses such as xxx/xxx` are uniformly redirected to `/home`. The effect is as follows:

![middleware.gif](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fdca5873307f494b88c091513c81d072~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=720&h=154&s=25085&e=gif&f=17&b=ffffff)

## Set matching path

Now that we understand the general purpose, let’s look at the specific usage.

Let’s first talk about how to set the matching path. There are two ways to specify the path for middleware matching.

### matcher configuration items

The first is to use the `matcher` configuration item. The sample code is as follows:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">export const config = {</span>
<span class="code-block-extension-codeLine" data-line-num="2">  matcher: &#39;/about/:path*&#39;,</span>
<span class="code-block-extension-codeLine" data-line-num="3">}</span>
</code></pre>

`matcher` not only supports string form, but also array form, which is used to match multiple paths:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">export const config = {</span>
<span class="code-block-extension-codeLine" data-line-num="2">  matcher: [&#39;/about/:path*&#39;, &#39;/dashboard/:path*&#39;],</span>
<span class="code-block-extension-codeLine" data-line-num="3">}</span>
</code></pre>

Students who are new to it may feel strange about the usage of `:path*`. Its function is to convert path strings such as `/user/:name` into regular expressions. Next.js uses path-to-regexp to resolve addresses. As an open source library with a history of ten years, path-to-regexp is also referenced by many well-known libraries such as express, react-router, vue-router and so on. So let us know more about it.

path-to-regexp defines **named parameters** (Named Parameters) by adding a colon before the parameter name. The matcher supports named parameters, such as `/about/:path` matches `/about/a` and `/about/ b`, but does not match `/about/a/c`

Note: During actual testing, `/about/:path` cannot match `/about/xxx`, but can only match `/about`. If you want to match `/about/xxx`, you need to write `/about/:path` /`

The default matching logic of named parameters is `[^/]+`, but you can also add a bracket after the named parameter to customize the matching logic of named parameters, such as `/about/icon-:foo(\\d+ ).png` matches `/about/icon-1.png` but not `/about/icon-a.png`.

Named parameters can use modifiers, where `*` means 0 or 1 or more, `?` means 0 or 1, `+` means 1 or more, for example

- `/about/:path*` match `/about`、`/about/xxx`、`/about/xxx/xxx`
- `/about/:path?` match `/about`、`/about/xxx`
- `/about/:path+` match `/about/xxx`、`/about/xxx/xxx`

You can also use standard regular expressions in parentheses, such as `/about/(.*)` is equivalent to `/about/:path*`, such as `/(about|settings)` matches `/about` and ` /settings`, does not match other addresses. `/user-(ya|yu)` matches `/user-ya` and `/user-yu`.

A more complex and commonly used example is:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">export const config = {</span>
<span class="code-block-extension-codeLine" data-line-num="2">  matcher: [</span>
<span class="code-block-extension-codeLine" data-line-num="3">    /*</span>
<span class="code-block-extension-codeLine" data-line-num="4">     * </span>
<span class="code-block-extension-codeLine" data-line-num="5">     * - api (API routes)</span>
<span class="code-block-extension-codeLine" data-line-num="6">     * - _next/static (static files)</span>
<span class="code-block-extension-codeLine" data-line-num="7">     * - _next/image (image optimization files)</span>
<span class="code-block-extension-codeLine" data-line-num="8">     * - favicon.ico (favicon file)</span>
<span class="code-block-extension-codeLine" data-line-num="9">     */</span>
<span class="code-block-extension-codeLine" data-line-num="10">    &#39;/((?!api|_next/static|_next/image|favicon.ico).*)&#39;,</span>
<span class="code-block-extension-codeLine" data-line-num="11">  ],</span>
<span class="code-block-extension-codeLine" data-line-num="12">}</span>
</code></pre>

In addition, note that the path must start with `/`. The value of `matcher` must be a constant so that it can be statically analyzed at build time. Using dynamic values such as variables will be ignored.

The power of matcher goes far beyond regular expressions. Matcher can also determine query parameters, cookies, and headers:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">export const config = {</span>
<span class="code-block-extension-codeLine" data-line-num="2">  matcher: [</span>
<span class="code-block-extension-codeLine" data-line-num="3">    {</span>
<span class="code-block-extension-codeLine" data-line-num="4">      source: &#39;/api/*&#39;,</span>
<span class="code-block-extension-codeLine" data-line-num="5">      has: [</span>
<span class="code-block-extension-codeLine" data-line-num="6">        { type: &#39;header&#39;, key: &#39;Authorization&#39;, value: &#39;Bearer Token&#39; },</span>
<span class="code-block-extension-codeLine" data-line-num="7">        { type: &#39;query&#39;, key: &#39;userId&#39;, value: &#39;123&#39; },</span>
<span class="code-block-extension-codeLine" data-line-num="8">      ],</span>
<span class="code-block-extension-codeLine" data-line-num="9">      missing: [{ type: &#39;cookie&#39;, key: &#39;session&#39;, value: &#39;active&#39; }],</span>
<span class="code-block-extension-codeLine" data-line-num="10">    },</span>
<span class="code-block-extension-codeLine" data-line-num="11">  ],</span>
<span class="code-block-extension-codeLine" data-line-num="12">}</span>
</code></pre>

In this example, not only does the routing address match, but the Authorization of the header must be Bearer Token, the userId of the query parameter is 123, and the session value in the cookie is not active.

### Conditional statements

The second way is to use conditional statements:

<pre><div class="code-block-extension-header"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">import { NextResponse } from &#39;next/server&#39;</span>
<span class="code-block-extension-codeLine" data-line-num="2"></span>
<span class="code-block-extension-codeLine" data-line-num="3">export function middleware(request) {</span>
<span class="code-block-extension-codeLine" data-line-num="4">  if (request.nextUrl.pathname.startsWith(&#39;/about&#39;)) {</span>
<span class="code-block-extension-codeLine" data-line-num="5">    return NextResponse.rewrite(new URL(&#39;/about-2&#39;, request.url))</span>
<span class="code-block-extension-codeLine" data-line-num="6">  }</span>
<span class="code-block-extension-codeLine" data-line-num="7"></span>
<span class="code-block-extension-codeLine" data-line-num="8">  if (request.nextUrl.pathname.startsWith(&#39;/dashboard&#39;)) {</span>
<span class="code-block-extension-codeLine" data-line-num="9">    return NextResponse.rewrite(new URL(&#39;/dashboard/user&#39;, request.url))</span>
<span class="code-block-extension-codeLine" data-line-num="10">  }</span>
<span class="code-block-extension-codeLine" data-line-num="11">}</span>
</code></pre>

The matcher is very powerful, but sometimes it’s a headache if you don’t know how to write it, so just write it in specific logic!
